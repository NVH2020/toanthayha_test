<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toán Thầy Hà</title>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
	<script>
	window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],  // cho phép $...$
    displayMath: [['$$','$$'], ['\\[','\\]']] // cho phép $$...$$
  }
	};
	</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .nav-btn { transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        .nav-btn-answered { background-color: #16a34a; color: white; border-color: #15803d; }
        .nav-btn-current { background-color: #4f46e5; color: white; border-color: #4338ca; transform: scale(1.1); }
        input[type="radio"]:checked + span { font-weight: 600; color: #4f46e5; }
        .mcq-label-selected {
            background-color: #e0e7ff; /* indigo-100 */
            border-color: #6366f1; /* indigo-500 */
        }
        /* === MÃ MỚI CHO HIỆU ỨNG NHẤP NHÁY === */
        @keyframes blinkingColors {
            0%, 100% { color: #22c55e; } /* Xanh lá */
            33% { color: #ef4444; }      /* Đỏ */
            66% { color: #eab308; }      /* Vàng */
        }
        .blinking-text {
            animation: blinkingColors 3s infinite;
        }

    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div id="main-container" class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6">
          <h1 class="text-2xl font-bold text-center mb-6 blinking-text">Lớp Toán Thầy Hà</h1>

        <div id="userInfoSection" class="max-w-md mx-auto">
            <h2 class="text-xl font-semibold text-center mb-4">Thông tin thí sinh</h2>
	    <div class="mb-4">
   	     <label class="block font-bold text-center text-blue-600">Mã kỳ thi (Kiểm tra)</label>
<p id="examCodeDisplay" class="w-full text-center text-lg font-bold text-red-600 p-2 mt-1"></p>
            </div>
            
<div class="mb-3">
                <label class="block font-medium">Số báo danh (VD: 520112)</label>
                <input type="text" id="studentId" class="w-full border rounded px-3 py-2 mt-1" required>
            </div>
            <div class="mb-3">
                <label class="block font-medium">Họ và tên(VD: Nguyễn Văn Hà)</label>
                <input type="text" id="fullname" class="w-full border rounded px-3 py-2 mt-1" required>
            </div>
            <div class="mb-3">
                <label class="block font-medium">Lớp(VD: 12A1, 12A11)</label>
                <input type="text" id="className" class="w-full border rounded px-3 py-2 mt-1" required>
            </div>
            <div class="mb-3">
                <label class="block font-medium">Trường(VD: THPT Yên Dũng số 2)</label>
                <input type="text" id="school" class="w-full border rounded px-3 py-2 mt-1" required>
            </div>
            <button id="startBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded mt-2">Bắt đầu làm bài</button>
        </div>

        <div id="quizSection" class="hidden">
            <div id="quiz-header" class="flex justify-between items-start border-b pb-4 mb-4">
                <div>
                    <h2 id="quiz-part-title" class="text-xl md:text-2xl font-bold text-gray-800"></h2>
                    <p class="text-lg font-semibold text-blue-600">
                        Câu <span id="question-counter">1</span> / <span id="total-questions-display"></span>
                    </p>
                </div>
                <div id="timer" class="text-2xl font-bold text-red-500">60:00</div>
            </div>
            
            <div id="questionNavPanel" class="flex flex-wrap gap-2 p-3 border-b mb-4 bg-gray-50 rounded-lg"></div>

            <form id="quizForm" class="space-y-6">
                <p id="question-text" class="text-lg font-medium text-gray-800 min-h-[48px]"></p>
                <div id="answer-container" class="space-y-3"></div>
                
                <div class="flex justify-between items-center pt-4 mt-4 border-t">
                    <button type="button" id="prevBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded">Câu trước</button>
                    <button type="submit" id="submitBtn" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded text-lg font-bold">Nộp bài</button>
                    <button type="button" id="nextBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded">Câu sau</button>
                </div>
            </form>
        </div>
        
        <div id="resultSection" class="hidden text-center">
            <h2 id="studentNameResult" class="text-2xl font-bold mb-2"></h2>
            <p class="text-lg mb-4">Đã hoàn thành bài kiểm tra!</p>
            <p class="text-xl">Tổng điểm của bạn là: 
                <span id="finalScore" class="font-bold text-blue-600 text-3xl"></span>
            </p>
            <p class="mt-4 text-gray-600">Kết quả đã được lưu vào hệ thống.</p>
            
            <div class="mt-8 p-4 border-t bg-gray-50 rounded-lg">
<img src="https://placehold.co/300x300/3B82F6/FBBF24?text=TOÁN%0ATHẦY+HÀ&font=times-new-roman&css=%7B%22font-weight%22%3A%22bold%22%2C%22font-size%22%3A%2290px%22%7D"
     alt="Logo Toán Thầy Hà" 
     class="mx-auto mb-4 rounded-full shadow-lg border-4 border-yellow-400 h-32 w-32 object-cover">                
	<h3 class="text-lg font-bold mb-2">Lớp toán thầy Hà tiếp tục tuyển sinh</h3>
                <p class="text-gray-600">
                    Nhóm nhỏ để đảm bảo sát sao và chất lượng!<br>
                    Luyện thi cơ bản và luyện thi chất lượng cao theo yêu cầu!
<br>
                    Địa chỉ học: Đội 6 - Xuân Phú – Tân Tiến – Bắc Ninh!
<br>
                    Liên hệ qua Zalo: <strong>0988.948.882</strong>
                </p>
            </div>
        </div>
    </div>

    <div id="announcementModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-lg w-full text-center">
            <img src="https://placehold.co/300x300/3B82F6/FBBF24?text=TOÁN%0ATHẦY+HÀ&font=times-new-roman&css=%7B%22font-weight%22%3A%22bold%22%2C%22font-size%22%3A%2290px%22%7D"
     alt="Logo Toán Thầy Hà" 
     class="mx-auto mb-4 rounded-full shadow-lg border-4 border-yellow-400 h-32 w-32 object-cover">            <h2 class="text-xl font-bold mb-2">Lớp toán thầy Hà tiếp tục tuyển sinh</h2>
            <p class="text-gray-600 mb-6">
                Nhóm nhỏ để đảm bảo sát sao và chất lượng!<br>
                Luyện thi cơ bản và luyện thi chất lượng cao theo yêu cầu!<br>
                Địa chỉ học: Đội 6 - Xuân Phú – Tân Tiến – Bắc Ninh!<br>
                Liên hệ qua Zalo: <strong>0988.948.882</strong>
            </p>
            <div class="flex justify-center gap-4">
                <button id="enterQuizBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-2 rounded">Vào thi</button>
                <button id="exitBtn" class="bg-red-500 hover:bg-red-600 text-white px-8 py-2 rounded">Thoát</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAwM9_H8PTooz3Nh4MPt9wdtBScIvMC318",
            authDomain: "toanthayha-cd96c.firebaseapp.com",
            projectId: "toanthayha-cd96c",
            storageBucket: "toanthayha-cd96c.firebasestorage.app",
            messagingSenderId: "940207284081",
            appId: "1:940207284081:web:9801158f72cc14053ae0d0",
            measurementId: "G-9D5ZQ66BSB"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ==========================================================
        // == CHỈ CẦN THAY ĐỔI MÃ KỲ THI Ở ĐÂY CHO CÁC LẦN SAU    == times
        // ==========================================================
        const EXAM_CODE = "Toan12_001";  //Mã kỳ thi(kiểm tra)
	// Gán mã kỳ thi vào phần hiển thị trong HTML
        document.getElementById("examCodeDisplay").textContent = EXAM_CODE;
        const QUIZ_ID = "toanthayha_12";
        const TIME_LIMIT_SECONDS = 60 * 60; 
        const ATTEMPT_LIMIT = 500;

// ==== nhapcauhoi       
 const originalQuizData = [
    {
        "part": "Phần I: Trắc nghiệm nhiều lựa chọn",
        "type": "mcq",
        "question": "Cho hàm số $y = \\frac{2x+1}{x+1}$. Mệnh đề nào dưới đây đúng?",
        "o": [
            "Hàm số đồng biến trên khoảng $(-\\infty; -1)$.",
            "Hàm số nghịch biến trên khoảng $(-1; +\\infty)$.",
            "Hàm số đồng biến trên khoảng $(-\\infty; -1)$ và $(-1; +\\infty)$.",
            "Hàm số nghịch biến trên khoảng $(-\\infty; -1)$ và $(-1; +\\infty)$."
        ],
        "a": "Hàm số đồng biến trên khoảng $(-\\infty; -1)$."
    },
    {
        "part": "Phần I: Trắc nghiệm nhiều lựa chọn",
        "type": "mcq",
        "question": "Cho hàm số $y=f(x)$ xác định, liên tục trên tập số thực $\\mathbb{R}$ và có đồ thị như hình bên. Hàm số $y=f(x)$ đạt cực tiểu tại điểm nào dưới đây? (có đồ thị như hình vẽ)",
        "o": [
            "$x=2$ và $x=-2$.",
            "$x=0$.",
            "$x=-2$.",
            "$y=-2$."
        ],
        "a": "$x=-2$."
    },
    {
        "part": "Phần I: Trắc nghiệm nhiều lựa chọn",
        "type": "mcq",
        "question": "Tìm giá trị lớn nhất của hàm số $y = x^4 - 2x^2 + 3$ trên đoạn $[0; 2]$",
        "o": [
            "$\\max_{[0;2]} y = 2$",
            "$\\max_{[0;2]} y = 3$",
            "$\\max_{[0;2]} y = 10$",
            "$\\max_{[0;2]} y = 11$"
        ],
        "a": "$\\max_{[0;2]} y = 11$"
    },
    {
        "part": "Phần I: Trắc nghiệm nhiều lựa chọn",
        "type": "mcq",
        "question": "Cho hàm số $y=f(x)$ liên tục trên đoạn $[-1; 2]$ và có đồ thị như hình vẽ. Gọi $M, m$ lần lượt là giá trị lớn nhất và giá trị nhỏ nhất của hàm số đã cho trên đoạn $[-1; 2]$. Ta có $M+m$ bằng:",
        "o": [
            "$M+m=0$.",
            "$M+m=2$.",
            "$M+m=1$.",
            "$M+m=5$."
        ],
        "a": "$M+m=1$."
    },
    {
        "part": "Phần I: Trắc nghiệm nhiều lựa chọn",
        "type": "mcq",
        "question": "Có bao nhiêu giá trị nguyên của tham số $m$ thuộc đoạn $[-2024; 2024]$ để hàm số $y = \\frac{x-1}{x-m}$ đồng biến trên từng khoảng xác định?",
        "o": [
            "2024.",
            "2025.",
            "4048.",
            "2023."
        ],
        "a": "2025."
    },
    {
        "part": "Phần I: Trắc nghiệm nhiều lựa chọn",
        "type": "mcq",
        "question": "Cho hàm số $y = f(x)$, bảng xét dấu của $y'$ như sau: (có bảng xét dấu). Hàm số đạt cực tiểu tại điểm nào?",
        "o": [
            "$x=1$.",
            "$x=2$.",
            "$x=-1$.",
            "$x=0$."
        ],
        "a": "$x=-1$."
    },
    {
        "part": "Phần I: Trắc nghiệm nhiều lựa chọn",
        "type": "mcq",
        "question": "Giá trị thực của tham số $m$ để hàm số $y = x^3 - 3mx^2 + 3(m^2-1)x - m^2$ đạt cực tiểu tại $x=2$ thuộc khoảng nào dưới đây?",
        "o": [
            "$(-2; 0)$.",
            "$(0; 2)$.",
            "$(3; 5)$.",
            "$(5; 7)$."
        ],
        "a": "$(0; 2)$."
    },
    {
        "part": "Phần I: Trắc nghiệm nhiều lựa chọn",
        "type": "mcq",
        "question": "Tính giá trị nhỏ nhất của hàm số $y = x + \\frac{4}{x}$ trên khoảng $(0; +\\infty)$.",
        "o": [
            "$\\min y = 2$",
            "$\\min y = 4$",
            "$\\min y = 0$",
            "$\\min y = 1$"
        ],
        "a": "$\\min y = 4$"
    },
    {
        "part": "Phần I: Trắc nghiệm nhiều lựa chọn",
        "type": "mcq",
        "question": "Một chất điểm chuyển động theo quy luật $s(t) = -\\frac{1}{3}t^3 + \\frac{9}{2}t^2 + 10t$ với t (giây) là khoảng thời gian tính từ lúc vật bắt đầu chuyển động và S (mét) là quãng đường vật chuyển động trong thời gian đó. Hỏi trong thời gian 10 giây, kể từ lúc bắt đầu chuyển động, vận tốc lớn nhất của chuyển động là bao nhiêu?",
        "o": [
            "25 (m/s).",
            "11 (m/s).",
            "100 (m/s).",
            "88 (m/s)."
        ],
        "a": "88 (m/s)."
    },
    {
        "part": "Phần I: Trắc nghiệm nhiều lựa chọn",
        "type": "mcq",
        "question": "Biết rằng giá trị nhỏ nhất của hàm số $y = |x^3 - 3x^2 + m|$ trên đoạn $[0; 3]$ bằng 7. Giá trị của tham số $m$ bằng",
        "o": [
            "$m=11$ hoặc $m=-7$.",
            "$m=11$.",
            "$m=7$.",
            "$m=-7$."
        ],
        "a": "$m=11$ hoặc $m=-7$."
    },
    {
        "part": "Phần II: Trắc nghiệm Đúng/Sai",
        "type": "true-false",
        "question": "Cho hàm số $y = x^3 - 3x^2 + 2$ có đồ thị $(C)$.",
        "s": [
            { "text": "Hàm số đồng biến trên khoảng $(0; 2)$.", "a": false },
            { "text": "Gọi $A, B$ là hai điểm cực trị của đồ thị $(C)$ khi đó $AB = 2\\sqrt{5}$.", "a": true },
            { "text": "Đường thẳng đi qua hai điểm cực trị của đồ thị hàm số chắn ra trên hai trục tọa độ một tam giác có diện tích là 4.", "a": false },
            { "text": "Giá trị cực đại của hàm số là 4.", "a": false }
        ]
    },
    {
        "part": "Phần II: Trắc nghiệm Đúng/Sai",
        "type": "true-false",
        "question": "Cho hàm số $y=f(x)$ liên tục trên tập $\\mathbb{R}$ và có bảng biến thiên như sau: (có bảng biến thiên)",
        "s": [
            { "text": "Giá trị lớn nhất của hàm số trên $\\mathbb{R}$ bằng 5.", "a": true },
            { "text": "Giá trị nhỏ nhất của hàm số bằng 2.", "a": false },
            { "text": "Giá trị lớn nhất của hàm số trên $[-1; 0]$ bằng 4.", "a": true },
            { "text": "Giá trị lớn nhất của hàm số trên $(0; +\\infty)$ bằng 5.", "a": true }
        ]
    },
    {
        "part": "Phần II: Trắc nghiệm Đúng/Sai",
        "type": "true-false",
        "question": "Cho hàm số $y = \\frac{x-m^2}{x+1}$ ($m$ là tham số). Các mệnh đề sau đúng hay sai?",
        "s": [
            { "text": "Tập xác định của hàm số là $D = \\mathbb{R} \\setminus \\{-1\\}$.", "a": true },
            { "text": "Với $m=1$, hàm số đã cho có giá trị nhỏ nhất trên $[0; 1]$ là $-\\frac{1}{2}$.", "a": false },
            { "text": "Với $m=\\sqrt{2}$, hàm số đã cho có giá trị lớn nhất trên $[0; 1]$ là $-\\frac{1}{2}$.", "a": true },
            { "text": "Biết rằng khi $m \\ne \\pm\\sqrt{2}$ thì hàm số đã cho có giá trị nhỏ nhất trên $[2; 4]$ bằng 2. Khi đó $m=4$.", "a": false }
        ]
    },
    {
        "part": "Phần III: Trả lời ngắn",
        "type": "short-answer",
        "question": "Có tất cả bao nhiêu giá trị nguyên của tham số $m$ để hàm số $y = x^3 - 3(m+1)x^2 + 9x - m$ đồng biến trên khoảng $(2; +\\infty)$?",
        "a": "3"
    },
    {
        "part": "Phần III: Trả lời ngắn",
        "type": "short-answer",
        "question": "Cho hàm số $y = x^3 - 3x^2 + 1$ có đồ thị $(C)$. Tính độ dài đoạn thẳng nối hai điểm cực trị của đồ thị $(C)$. (Làm tròn đến hàng phần trăm)",
        "a": "4.47"
    },
    {
        "part": "Phần III: Trả lời ngắn",
        "type": "short-answer",
        "question": "Cho hàm số $y=f(x)$ có đạo hàm trên khoảng $(0; +\\infty)$ thỏa mãn $f'(x) = x^2(x-1)(x-2)^3(x-4)$. Biết $f(0)=0$ thì giá trị nhỏ nhất và giá trị lớn nhất của hàm số $g(x)=f(x^2)$ trên đoạn $[1; 2]$ lần lượt là $m, M$. Giá trị $M-m$ bằng ... (làm tròn kết quả đến hàng phần trăm)",
        "a": ""
    },
    {
        "part": "Phần III: Trả lời ngắn",
        "type": "short-answer",
        "question": "Cho hai vị trí A, B cách nhau 650m, cùng nằm về một phía bờ sông. Khoảng cách từ A và từ B đến bờ sông lần lượt là 150m và 290m. Một người đi từ A đến bờ sông để lấy nước mang về B. Đoạn đường ngắn nhất mà người đó có thể đi là bao nhiêu mét? (kết quả làm tròn đến hàng đơn vị)",
        "a": "780"
    }
];
        let quizData = [];
        const totalQuestions = originalQuizData.length;

        const startBtn = document.getElementById("startBtn");
        const userInfoSection = document.getElementById("userInfoSection");
        const quizSection = document.getElementById("quizSection");
        const resultSection = document.getElementById("resultSection");
        const announcementModal = document.getElementById('announcementModal');
        const enterQuizBtn = document.getElementById('enterQuizBtn');
        const exitBtn = document.getElementById('exitBtn');
        const mainContainer = document.getElementById('main-container');

        const quizForm = document.getElementById("quizForm");
        const studentNameResult = document.getElementById("studentNameResult");
        const finalScore = document.getElementById("finalScore");
        const timerElement = document.getElementById("timer");
        const quizPartTitle = document.getElementById('quiz-part-title');
        const questionCounter = document.getElementById('question-counter');
        const totalQuestionsDisplay = document.getElementById('total-questions-display');
        const questionNavPanel = document.getElementById('questionNavPanel');
        const questionText = document.getElementById('question-text');
        const answerContainer = document.getElementById('answer-container');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        let currentUser = null;
        let timerInterval = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let quizStartTime = null;

        totalQuestionsDisplay.textContent = totalQuestions; 

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function prepareShuffledQuiz() {
            const groupedByPart = originalQuizData.reduce((acc, question) => {
                acc[question.part] = acc[question.part] || [];
                acc[question.part].push(question);
                return acc;
            }, {});
            let shuffledQuiz = [];
            for (const part in groupedByPart) {
                const questionsInPart = groupedByPart[part];
                shuffleArray(questionsInPart);
                shuffledQuiz = shuffledQuiz.concat(questionsInPart);
            }
            return shuffledQuiz;
        }

        startBtn.addEventListener("click", async () => {
            const studentId = document.getElementById("studentId").value.trim();
            const fullname = document.getElementById("fullname").value.trim();
            const className = document.getElementById("className").value.trim();
            const school = document.getElementById("school").value.trim();

            if (!studentId || !fullname || !className || !school) {
                alert("Vui lòng nhập đầy đủ thông tin!"); return;
            }
            
            currentUser = { 
                examCode: EXAM_CODE, 
                studentId, 
                fullname, 
                className, 
                school 
            };
            
            const resultsRef = collection(db, "quizResults");
            const q = query(resultsRef, 
                where("studentId", "==", studentId), 
                where("quizId", "==", QUIZ_ID),
                where("examCode", "==", EXAM_CODE) 
            );
            
            const snapshot = await getDocs(q);
            if (snapshot.size >= ATTEMPT_LIMIT) {
                alert(`Bạn đã làm bài kiểm tra này ${snapshot.size} lần cho kỳ thi ${EXAM_CODE}. Số lần làm bài tối đa là ${ATTEMPT_LIMIT}.`);
                return;
            }
            
            mainContainer.classList.add('hidden');
            announcementModal.classList.remove('hidden');
        });

        enterQuizBtn.addEventListener('click', () => {
            announcementModal.classList.add('hidden');
            mainContainer.classList.remove('hidden');
            userInfoSection.classList.add("hidden");
            quizSection.classList.remove("hidden");
            startQuiz();
        });

        exitBtn.addEventListener('click', () => {
            location.reload();
        });

        function startQuiz() {
            quizData = prepareShuffledQuiz();
            userAnswers = new Array(totalQuestions).fill(null);
            currentQuestionIndex = 0;
            quizStartTime = Date.now();
            renderNavPanel();
            jumpToQuestion(0);
            startTimer();
        }
        
        function startTimer() {
            let timeLeft = TIME_LIMIT_SECONDS;
            timerInterval = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitBtn.click();
                } else {
                    timeLeft--;
                    const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                    const seconds = (timeLeft % 60).toString().padStart(2, '0');
                    timerElement.textContent = `${minutes}:${seconds}`;
                }
            }, 1000);
        }

        function renderNavPanel() {
            questionNavPanel.innerHTML = '';
            for (let i = 0; i < totalQuestions; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'nav-btn w-10 h-10 border rounded font-medium';
                btn.type = 'button';
                btn.onclick = () => {
                    saveCurrentAnswer();
                    jumpToQuestion(i);
                };
                questionNavPanel.appendChild(btn);
            }
        }

        function jumpToQuestion(index) {
            currentQuestionIndex = index;
            showQuestion();
            updateNavPanel();
        }

        function showQuestion() {
            const question = quizData[currentQuestionIndex];
            quizPartTitle.textContent = question.part;
            questionCounter.textContent = currentQuestionIndex + 1;
            questionText.innerHTML = question.question;
            answerContainer.innerHTML = '';

            switch (question.type) {
                case 'mcq': renderMCQ(question); break;
                case 'true-false': renderTrueFalse(question); break;
                case 'short-answer': renderShortAnswer(question); break;
            }
	if (window.MathJax) {
        MathJax.typesetPromise();
    }            
            prevBtn.classList.toggle('hidden', currentQuestionIndex === 0);
            nextBtn.classList.toggle('hidden', currentQuestionIndex === totalQuestions - 1);
        }
        
        function updateNavPanel() {
            const navButtons = questionNavPanel.children;
            for (let i = 0; i < navButtons.length; i++) {
                navButtons[i].classList.remove('nav-btn-current', 'nav-btn-answered');
                if (userAnswers[i] !== null) {
                    navButtons[i].classList.add('nav-btn-answered');
                }
                if (i === currentQuestionIndex) {
                    navButtons[i].classList.add('nav-btn-current');
                }
            }
        }

        function saveCurrentAnswer() {
            const question = quizData[currentQuestionIndex];
            let answerData = null;
            switch (question.type) {
                case 'mcq':
                    const selectedRadio = quizForm.querySelector(`input[name="q${currentQuestionIndex}"]:checked`);
                    if (selectedRadio) answerData = selectedRadio.value;
                    break;
                case 'true-false':
                    answerData = [];
                    for (let i = 0; i < question.s.length; i++) {
                        const selectedTF = quizForm.querySelector(`input[name="q${currentQuestionIndex}s${i}"]:checked`);
                        answerData.push(selectedTF ? selectedTF.value === 'true' : null);
                    }
                    if (answerData.every(a => a === null)) answerData = null;
                    break;
                case 'short-answer':
                    const input = quizForm.querySelector(`input[name="q${currentQuestionIndex}"]`);
                    if (input && input.value.trim() !== '') answerData = input.value.trim();
                    break;
            }
            userAnswers[currentQuestionIndex] = answerData;
            updateNavPanel();
        }

        prevBtn.addEventListener('click', () => {
            saveCurrentAnswer();
            if (currentQuestionIndex > 0) jumpToQuestion(currentQuestionIndex - 1);
        });

        nextBtn.addEventListener('click', () => {
            saveCurrentAnswer();
            if (currentQuestionIndex < totalQuestions - 1) jumpToQuestion(currentQuestionIndex + 1);
        });
        
        quizForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            saveCurrentAnswer(); 
            clearInterval(timerInterval);
            
            const timeTakenInSeconds = Math.round((Date.now() - quizStartTime) / 1000);
            let totalScore = 0;
            const answersToSave = {};

            quizData.forEach((q, index) => {
                const userAnswer = userAnswers[index];
                answersToSave[`q${index + 1}`] = userAnswer;
                if (userAnswer === null) return;

// ==== tinhdiem                
switch (q.type) {
                    case 'mcq':
                        if (userAnswer === q.a) totalScore += 0.5;
                        break;
                    case 'true-false':
                        let correctCount = 0;
                        q.s.forEach((st, sIndex) => { if (userAnswer[sIndex] === st.a) correctCount++; });
                        const pointsMap = [0, 0.1, 0.25, 0.5, 1];
                        totalScore += pointsMap[correctCount] || 0;
                        break;
                    case 'short-answer':
                        if (userAnswer.toLowerCase() === q.a.toLowerCase()) totalScore += 0.5;
                        break;
                }
            });

            quizSection.classList.add("hidden");
            resultSection.classList.remove("hidden");
            studentNameResult.textContent = currentUser.fullname;
            finalScore.textContent = totalScore.toFixed(2);

            try {
                await addDoc(collection(db, "quizResults"), {
                    ...currentUser,
                    quizId: QUIZ_ID,
                    score: parseFloat(totalScore.toFixed(2)),
                    totalPossibleScore: 10,
                    timeTaken: timeTakenInSeconds,
                    answers: answersToSave,
                    submittedAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Lỗi khi lưu kết quả: ", error);
                alert("Đã có lỗi xảy ra khi lưu kết quả của bạn. Vui lòng thử lại.");
            }
        });

        function renderMCQ(question) {
            const savedAnswer = userAnswers[currentQuestionIndex];
            const options = [...question.o];
            shuffleArray(options); // Xáo trộn đáp án
            options.forEach(option => {
                const isChecked = savedAnswer === option;
                answerContainer.innerHTML += `
                    <div><label class="flex items-center p-3 rounded-lg border cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="q${currentQuestionIndex}" value="${option}" class="mr-3" ${isChecked ? 'checked' : ''}> 
                        <span>${option}</span>
                    </label></div>`;
            });
        }

        function renderTrueFalse(question) {
            const savedAnswer = userAnswers[currentQuestionIndex] || [];
            question.s.forEach((statement, sIndex) => {
                const isTrueChecked = savedAnswer[sIndex] === true;
                const isFalseChecked = savedAnswer[sIndex] === false;
                answerContainer.innerHTML += `
                    <div class="flex items-center justify-between p-3 border rounded-lg">
                        <span>${statement.text}</span>
                        <div class="flex gap-4">
                            <label class="cursor-pointer flex items-center">
                                <input type="radio" name="q${currentQuestionIndex}s${sIndex}" value="true" class="mr-2" ${isTrueChecked ? 'checked' : ''}> Đúng
                            </label>
                            <label class="cursor-pointer flex items-center">
                                <input type="radio" name="q${currentQuestionIndex}s${sIndex}" value="false" class="mr-2" ${isFalseChecked ? 'checked' : ''}> Sai
                            </label>
                        </div>
                    </div>`;
            });
        }
        
        function renderShortAnswer(question) {
            const savedAnswer = userAnswers[currentQuestionIndex] || '';
            answerContainer.innerHTML = `
                <input type="text" name="q${currentQuestionIndex}" class="w-full border rounded px-3 py-2 mt-2" 
                placeholder="Nhập đáp án(45 hoặc 20,5)" value="${savedAnswer}">`;
        }
    </script>
</body>
</html>
