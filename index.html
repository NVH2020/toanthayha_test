<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ToÃ¡n Tháº§y HÃ  - Thi</title>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']]
      }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .nav-btn { transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        .nav-btn-answered { background-color: #16a34a; color: white; border-color: #15803d; }
        .nav-btn-current { background-color: #4f46e5; color: white; border-color: #4338ca; transform: scale(1.05); }
        .mcq-label-selected { background-color: #e0e7ff; border-color: #6366f1; }
        @keyframes blinkingColors {
            0%,100% { color: #22c55e; } 33% { color: #ef4444; } 66% { color: #eab308; }
        }
        .blinking-text { animation: blinkingColors 3s infinite; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div id="main-container" class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6">
        <h1 class="text-2xl font-bold text-center mb-6 blinking-text">Lá»›p ToÃ¡n Tháº§y HÃ </h1>

        <div id="userInfoSection" class="max-w-md mx-auto">
            <h2 class="text-xl font-semibold text-center mb-4">ThÃ´ng tin thÃ­ sinh</h2>
            <div class="mb-4">
                <label class="block font-bold text-center text-blue-600">MÃ£ ká»³ thi (Kiá»ƒm tra)</label>
                <p id="examCodeDisplay" class="w-full text-center text-lg font-bold text-red-600 p-2 mt-1"></p>
            </div>

            <div class="mb-3">
                <label class="block font-medium">Sá»‘ bÃ¡o danh (VD: 520112)</label>
                <input type="text" id="studentId" class="w-full border rounded px-3 py-2 mt-1" required>
            </div>
            <div class="mb-3">
                <label class="block font-medium">Há» vÃ  tÃªn (VD: Nguyá»…n VÄƒn HÃ )</label>
                <input type="text" id="fullname" class="w-full border rounded px-3 py-2 mt-1" required>
            </div>
            <div class="mb-3">
                <label class="block font-medium">Lá»›p (VD: 12A1, 12A10)</label>
                <input type="text" id="className" class="w-full border rounded px-3 py-2 mt-1" required>
            </div>
            <div class="mb-3">
    	<label class="block font-medium">TrÆ°á»ng</label>
  	 <select id="schoolSelect" class="w-full border rounded px-3 py-2 mt-1">
        <option value="">-- Chá»n trÆ°á»ng --</option>
        <option value="THPT YÃªn DÅ©ng sá»‘ 2">THPT YÃªn DÅ©ng sá»‘ 2</option>
        <option value="THPT YÃªn DÅ©ng sá»‘ 1">THPT YÃªn DÅ©ng sá»‘ 1</option>
        <option value="THPT Lá»¥c Nam">THPT Lá»¥c Nam</option>
        <option value="THPT TÃ¢n YÃªn 1">THPT TÃ¢n YÃªn 1</option>
        <option value="KhÃ¡c">KhÃ¡c...</option>
    	</select>
    	<input type="text" id="schoolInput" class="w-full border rounded px-3 py-2 mt-2 hidden" placeholder="Nháº­p tÃªn trÆ°á»ng khÃ¡c">
	</div>

            <button id="startBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded mt-2">Báº¯t Ä‘áº§u lÃ m bÃ i</button>
        </div>

        <div id="quizSection" class="hidden">
            <div id="quiz-header" class="flex justify-between items-start border-b pb-4 mb-4">
                <div>
                    <h2 id="quiz-part-title" class="text-xl md:text-2xl font-bold text-gray-800"></h2>
                    <p class="text-lg font-semibold text-blue-600">
                        CÃ¢u <span id="question-counter">1</span> / <span id="total-questions-display"></span>
                    </p>
                </div>
                <div>
                    <div id="timer" class="text-2xl font-bold text-red-500">00:00</div>
                    <div id="timeHint" class="text-sm text-gray-500 text-right">Thá»i gian lÃ m bÃ i</div>
                </div>
            </div>

            <div id="questionNavPanel" class="flex flex-wrap gap-2 p-3 border-b mb-4 bg-gray-50 rounded-lg"></div>

            <form id="quizForm" class="space-y-6">
                <p id="question-text" class="text-lg font-medium text-gray-800 min-h-[48px]"></p>
                <div id="answer-container" class="space-y-3"></div>

                <div class="flex justify-between items-center pt-4 mt-4 border-t">
                    <button type="button" id="prevBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded">CÃ¢u trÆ°á»›c</button>
                    <div class="flex gap-3">
                        <button type="button" id="reviewTimeBtn" class="bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-2 rounded">Xem bá»™ thá»i gian</button>
                        <button type="submit" id="submitBtn" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded text-lg font-bold">Ná»™p bÃ i</button>
                    </div>
                    <button type="button" id="nextBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded">CÃ¢u sau</button>
                </div>
            </form>
        </div>

        <div id="countdown" class="text-red-600 font-bold text-lg my-2"></div>

        <div id="resultSection" class="hidden text-center">
            <h2 id="studentNameResult" class="text-2xl font-bold mb-2"></h2>
            <p class="text-lg mb-4">ÄÃ£ hoÃ n thÃ nh bÃ i kiá»ƒm tra!</p>
            <p class="text-xl">Tá»•ng Ä‘iá»ƒm cá»§a báº¡n lÃ :
                <span id="finalScore" class="font-bold text-blue-600 text-3xl"></span>
            </p>
            <p class="mt-4 text-gray-600">Káº¿t quáº£ Ä‘Ã£ Ä‘Æ°á»£c lÆ°u vÃ o há»‡ thá»‘ng.</p>
        </div>
    </div>

    <!-- Modal quáº£ng cÃ¡o / xÃ¡c nháº­n vÃ o thi -->
    <div id="announcementModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-lg w-full text-center">
            <h2 class="text-xl font-bold mb-2">Lá»›p toÃ¡n tháº§y HÃ  tiáº¿p tá»¥c tuyá»ƒn sinh</h2>
            <p class="text-gray-600 mb-6">
                NhÃ³m nhá» Ä‘á»ƒ Ä‘áº£m báº£o sÃ¡t sao vÃ  cháº¥t lÆ°á»£ng!<br>
                Äá»‹a chá»‰ há»c: Äá»™i 6 - XuÃ¢n PhÃº â€“ TÃ¢n Tiáº¿n â€“ Báº¯c Ninh!<br>
                LiÃªn há»‡ qua Zalo: <strong>0988.948.882</strong>
            </p>
            <div class="flex justify-center gap-4">
                <button id="enterQuizBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-2 rounded">VÃ o thi</button>
                <button id="exitBtn" class="bg-red-500 hover:bg-red-600 text-white px-8 py-2 rounded">ThoÃ¡t</button>
            </div>
        </div>
    </div>

    <!-- Modal confirm ná»™p bÃ i -->
    <div id="confirmSubmitModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full text-center">
            <h3 class="text-lg font-bold mb-3">Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n ná»™p bÃ i khÃ´ng?</h3>
            <p class="mb-4 text-gray-600">Sau khi ná»™p, báº¡n khÃ´ng thá»ƒ sá»­a Ä‘Ã¡p Ã¡n.</p>
            <div class="flex justify-center gap-4">
                <button id="confirmYes" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded">Yes</button>
                <button id="confirmNo" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded">No</button>
            </div>
        </div>
    </div>

    <!-- Modal xem bá»™ thá»i gian -->
    <div id="timeInfoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
            <h3 class="text-lg font-bold mb-3">Bá»™ thá»i gian</h3>
            <p class="mb-2"><strong>MÃ£ ká»³ thi:</strong> <span id="modalExamCode"></span></p>
            <p class="mb-2"><strong>Giá» má»Ÿ Ä‘á»:</strong> <span id="modalStartTime"></span></p>
            <p class="mb-2"><strong>Giá» Ä‘Ã³ng Ä‘á»:</strong> <span id="modalDeadline"></span></p>
            <p class="mb-4 text-sm text-gray-600">Thá»i gian lÃ m bÃ i tÃ­nh tá»« lÃºc báº¡n nháº¥n "VÃ o thi".</p>
            <div class="text-right">
                <button id="closeTimeInfo" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">ÄÃ³ng</button>
            </div>
        </div>
    </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ====== Cáº¥u hÃ¬nh Firebase ======
const firebaseConfig = {
    apiKey: "AIzaSyAwM9_H8PTooz3Nh4MPt9wdtBScIvMC318",
    authDomain: "toanthayha-cd96c.firebaseapp.com",
    projectId: "toanthayha-cd96c",
    storageBucket: "toanthayha-cd96c.firebasestorage.app",
    messagingSenderId: "940207284081",
    appId: "1:940207284081:web:9801158f72cc14053ae0d0",
    measurementId: "G-9D5ZQ66BSB"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ====== Cáº¥u hÃ¬nh ká»³ thi ======
const EXAM_CODE = "Toan12_002";
const QUIZ_ID = "toanthayha_12";
const TIME_LIMIT_SECONDS = 60 * 60; // thá»i gian lÃ m bÃ i (giÃ¢y). chá»‰nh á»Ÿ Ä‘Ã¢y
const ATTEMPT_LIMIT = 2;            // giá»›i háº¡n sá»‘ láº§n lÃ m bÃ i má»—i SBD
const START_TIME = "2025-10-03T20:00:00"; // thá»i gian má»Ÿ
const DEADLINE = "2025-10-10T23:00:00";   // thá»i gian Ä‘Ã³ng

// ====== DOM ======
const examCodeDisplay = document.getElementById("examCodeDisplay");
const startBtn = document.getElementById("startBtn");
const announcementModal = document.getElementById("announcementModal");
const enterQuizBtn = document.getElementById("enterQuizBtn");
const exitBtn = document.getElementById("exitBtn");
const userInfoSection = document.getElementById("userInfoSection");
const quizSection = document.getElementById("quizSection");
const resultSection = document.getElementById("resultSection");
const timerElement = document.getElementById("timer");
const countdownEl = document.getElementById("countdown");
const reviewTimeBtn = document.getElementById("reviewTimeBtn");

const confirmSubmitModal = document.getElementById("confirmSubmitModal");
const confirmYes = document.getElementById("confirmYes");
const confirmNo = document.getElementById("confirmNo");

const timeInfoModal = document.getElementById("timeInfoModal");
const modalExamCode = document.getElementById("modalExamCode");
const modalStartTime = document.getElementById("modalStartTime");
const modalDeadline = document.getElementById("modalDeadline");
const closeTimeInfo = document.getElementById("closeTimeInfo");

const quizForm = document.getElementById("quizForm");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const submitBtn = document.getElementById("submitBtn");
// Xá»­ lÃ½ chá»n trÆ°á»ng
const schoolSelect = document.getElementById("schoolSelect");
const schoolInput = document.getElementById("schoolInput");

schoolSelect.addEventListener("change", () => {
    if (schoolSelect.value === "KhÃ¡c") {
        schoolInput.classList.remove("hidden");
        schoolInput.value = "";
    } else {
        schoolInput.classList.add("hidden");
        schoolInput.value = schoolSelect.value;
    }
});


// Hiá»ƒn thá»‹ mÃ£ ká»³ thi
examCodeDisplay.textContent = EXAM_CODE;

// Hiá»ƒn thá»‹ modal thÃ´ng tin thá»i gian
modalExamCode.textContent = EXAM_CODE;
modalStartTime.textContent = (new Date(START_TIME)).toLocaleString();
modalDeadline.textContent = (new Date(DEADLINE)).toLocaleString();

reviewTimeBtn.addEventListener("click", () => timeInfoModal.classList.remove("hidden"));
closeTimeInfo.addEventListener("click", () => timeInfoModal.classList.add("hidden"));

// === Countdown má»Ÿ/Ä‘Ã³ng Ä‘á» ===
function formatDiff(ms) {
    if (ms < 0) ms = 0;
    const totalSeconds = Math.floor(ms / 1000);
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    return `${h}h ${m}m ${s}s`;
}
function updateCountdown() {
    const now = new Date();
    const startDate = new Date(START_TIME);
    const endDate = new Date(DEADLINE);
    let msg = "";
    if (now < startDate) {
        msg = "â³ BÃ i kiá»ƒm tra sáº½ má»Ÿ sau: " + formatDiff(startDate - now);
    } else if (now >= startDate && now <= endDate) {
        msg = "ğŸ“ BÃ i kiá»ƒm tra Ä‘ang má»Ÿ. CÃ²n thá»i gian tá»›i khi Ä‘Ã³ng Ä‘á»: " + formatDiff(endDate - now);
    } else {
        msg = "âŒ BÃ i kiá»ƒm tra Ä‘Ã£ káº¿t thÃºc.";
        startBtn.disabled = true;
        startBtn.textContent = "ÄÃ£ háº¿t háº¡n lÃ m bÃ i";
        startBtn.classList.add('bg-gray-400','cursor-not-allowed');
    }
    countdownEl.textContent = msg;
}
setInterval(updateCountdown, 1000);
updateCountdown();

// ========== Dá»¯ liá»‡u cÃ¢u há»i (giá»¯ nguyÃªn nhÆ° gá»‘c) ==========
const originalQuizData = [{
"part": "Phan I: Cau trac nghiem nhieu phuong an lua chon",
"type": "mcq",
"question": "Cho hÃ m sá»‘$y=f\\left(x \\right)$ cÃ³ Ä‘á»“ thá»‹ nhÆ° hÃ¬nh váº½ bÃªn dÆ°á»›i. <br> <img src=\"https://raw.githubusercontent.com/NVH2020/Anhbaithi/main/01.01.02.png\" alt=\"Äá»“ thá»‹ hÃ m sá»‘\" class=\"mx-auto my-3 rounded-lg shadow-md max-w-full\"> <br>  Há»i Ä‘á»“ thá»‹ cá»§a hÃ m sá»‘ $y=f\\left(x \\right)$cÃ³ bao nhiÃªu Ä‘iá»ƒm cá»±c trá»‹?",
"o": ["$1$.", "$2$.", "$3$.", "$4$."],
"a": "$2$."
},
{
"part": "Phan I: Cau trac nghiem nhieu phuong an lua chon",
"type": "mcq",
"question": "Äá»“ thá»‹ cá»§a hÃ m sá»‘ nÃ o dÆ°á»›i Ä‘Ã¢y cÃ³ tiá»‡m cáº­n ngang?",
"o": ["$y=\\frac{3x+1}{x-1}$.", "$y=-{{x}^{3}}+3{{x}^{2}}+3x+1$.", "$y=\\frac{{{x}^{2}}+x+1}{x-1}$.", "$y={{x}^{4}}+{{x}^{2}}$."],
"a": "$y=\\frac{3x+1}{x-1}$."
},
{
"part": "Phan I: Cau trac nghiem nhieu phuong an lua chon",
"type": "mcq",
"question": "Cho hÃ m sá»‘ $y={{x}^{3}}+3x+2$. Má»‡nh Ä‘á» nÃ o dÆ°á»›i Ä‘Ã¢y lÃ  Ä‘Ãºng?",
"o": ["HÃ m sá»‘ Ä‘á»“ng biáº¿n trÃªn khoáº£ng $\\left(-\\infty ;+\\infty \\right)$.", "HÃ m sá»‘ nghá»‹ch biáº¿n trÃªn khoáº£ng $\\left(-\\infty ;+\\infty \\right)$.", "HÃ m sá»‘ nghá»‹ch biáº¿n trÃªn khoáº£ng $\\left(-\\infty ;0 \\right)$ vÃ  Ä‘á»“ng biáº¿n trÃªn khoáº£ng $\\left(0;+\\infty \\right)$.", "HÃ m sá»‘ Ä‘á»“ng biáº¿n trÃªn khoáº£ng $\\left(-\\infty ;0 \\right)$ vÃ  Ä‘á»“ng biáº¿n trÃªn khoáº£ng $\\left(0;+\\infty \\right)$"],
"a": "HÃ m sá»‘ Ä‘á»“ng biáº¿n trÃªn khoáº£ng $\\left(-\\infty ;+\\infty \\right)$."
},
{
"part": "Phan I: Cau trac nghiem nhieu phuong an lua chon",
"type": "mcq",
"question": "Cho hÃ m sá»‘ $y=f\\left(x \\right)$cÃ³ báº£ng biáº¿n thiÃªn nhÆ° hÃ¬nh bÃªn dÆ°á»›i. <br>  <img src=\"https://raw.githubusercontent.com/NVH2020/Anhbaithi/main/01.04.02.png\" alt=\"Äá»“ thá»‹ hÃ m sá»‘\" class=\"mx-auto my-3 rounded-lg shadow-md max-w-full\">  <br>  Sá»‘ Ä‘iá»ƒm cá»±c trá»‹ cá»§a hÃ m sá»‘ $f(-2x)$lÃ  bao nhiÃªu?",
"o": ["$5$.", "$3$.", "$6$.", "$4$."],
"a": "$3$."
},
{
"part": "Phan I: Cau trac nghiem nhieu phuong an lua chon",
"type": "mcq",
"question": "TÃ¬m táº¥t cáº£ cÃ¡c giÃ¡ trá»‹ thá»±c cá»§a tham sá»‘ $m$ Ä‘á»ƒ giÃ¡ trá»‹ nhá» nháº¥t cá»§a hÃ m sá»‘ $y=\\frac{x+2{{m}^{2}}-m}{x-3}$ trÃªn Ä‘oáº¡n $\\left[ 0;1 \\right]$ báº±ng $-2$.",
"o": ["$m=1$  hoáº·c $m=-\\frac{1}{2}$.", "$m=3$  hoáº·c $m=-\\frac{5}{2}$.", "$m=-1$  hoáº·c $m=\\frac{3}{2}$.", "$m=2$  hoáº·c $m=-\\frac{3}{2}$."],
"a": "$m=-1$  hoáº·c $m=\\frac{3}{2}$."
},
{
"part": "Phan I: Cau trac nghiem nhieu phuong an lua chon",
"type": "mcq",
"question": "CÃ¡c chuyÃªn gia Y-táº¿ Æ°á»›c tÃ­nh sá»‘ ngÆ°á»i nhiá»…m virus Zika ká»ƒ tá»« ngÃ y xuáº¥t hiá»‡n bá»‡nh nhÃ¢n Ä‘áº§u tiÃªn Ä‘áº¿n ngÃ y thá»© $t$ lÃ  $f\\left(t \\right)=45{{t}^{2}}-{{t}^{3}},\\left(t=0,1,2,...,25 \\right)$. Náº¿u coi $f\\left(t \\right)$lÃ  má»™t hÃ m xÃ¡c Ä‘á»‹nh trÃªn Ä‘oáº¡n $\\left[ 0;25 \\right]$ thÃ¬ $f'\\left(t \\right)$ Ä‘Æ°á»£c xem lÃ  tá»‘c Ä‘á»™ truyá»n bá»‡nh (ngÆ°á»i/ngÃ y) táº¡i thá»i Ä‘iá»ƒm $t$. Tá»‘c Ä‘á»™ truyá»n bá»‡nh sáº½ lá»›n nháº¥t vÃ o ngÃ y thá»© máº¥y?",
"o": ["$5$ .", "$15$ .", "$20$ .", "$8$ ."],
"a": "$15$ ."
},
{
  "part": "Phan I: Cau trac nghiem nhieu phuong an lua chon",
  "type": "mcq",
  "question": "GiÃ¡ trá»‹ nhá» nháº¥t cá»§a hÃ m sá»‘ $f\\left(x \\right) = x^{4} - 6x^{2} - 1$ trÃªn Ä‘oáº¡n $[-1;3]$ báº±ng",
  "o": ["$-1$", "$-10$", "$-11$", "$-26$"],
  "a": "$-10$"
},
{
"part": "Phan I: Cau trac nghiem nhieu phuong an lua chon",
"type": "mcq",
"question": "Cho Ä‘Æ°á»ng cong $\\left(C \\right):y=\\frac{2x+3}{x-1}$ vÃ  $M$ lÃ  má»™t Ä‘iá»ƒm náº±m trÃªn $\\left(C \\right)$. Giáº£ sá»­ ${{d}_{1}}$, ${{d}_{2}}$ tÆ°Æ¡ng á»©ng lÃ  cÃ¡c khoáº£ng cÃ¡ch tá»« $M$ Ä‘áº¿n hai tiá»‡m cáº­n (Ä‘á»©ng vÃ  ngang) cá»§a $\\left(C \\right)$, khi Ä‘Ã³ ${{d}_{1}}.{{d}_{2}}$ báº±ng",
"o": ["$3$.", "$4$.", "$5$.", "$6$."],
"a": "$5$."
},
{
"part": "Phan I: Cau trac nghiem nhieu phuong an lua chon",
"type": "mcq",
"question": "CÃ³ bao nhiÃªu giÃ¡ trá»‹ nguyÃªn cá»§a tham sá»‘ $m$ Ä‘á»ƒ hÃ m sá»‘ $y=\\frac{x+{{m}^{2}}}{x+4}$ Ä‘á»“ng biáº¿n trÃªn tá»«ng khoáº£ng xÃ¡c Ä‘á»‹nh cá»§a nÃ³?",
"o": ["$1$.", "$2$.", "$3$.", "$5$."],
"a": "$3$."
},
{
"part": "Phan I: Cau trac nghiem nhieu phuong an lua chon",
"type": "mcq",
"question": "Cho hÃ m sá»‘ $y=f\\left(x \\right)$ cÃ³ Ä‘áº¡o hÃ m liÃªn tá»¥c trÃªn $\\left[ -3;\\,3 \\right]$ vÃ  hÃ m sá»‘ $y={f}'\\left(x \\right)$ cÃ³ Ä‘á»“ thá»‹ nhÆ° hÃ¬nh váº½ bÃªn dÆ°á»›i. <br> <img src=\"https://raw.githubusercontent.com/NVH2020/Anhbaithi/main/01.10.02.png\" alt=\"Äá»“ thá»‹ hÃ m sá»‘\" class=\"mx-auto my-3 rounded-lg shadow-md max-w-full\"> <br> HÃ m sá»‘ $y=f(x)$ nghá»‹ch biáº¿n trÃªn khoáº£ng nÃ o?",
"o": ["$\\left(0;\\,2 \\right)$.", "$\\left(2;\\,3 \\right)$.", "$\\left(-3;\\,-1 \\right)$.", "$\\left(-1;\\,0 \\right)$."],
"a": "$\\left(-1;\\,0 \\right)$."
},
{
"part": "Phan II: Cau trac nghiem dung sai",
"type": "true-false",
"question": "Cho hÃ m sá»‘ $y=\\frac{{{x}^{2}}-2x}{x-1}$ cÃ³ Ä‘á»“ thá»‹ lÃ  $(C)$.",
"s": [
{"text": "Äá»“ thá»‹ hÃ m sá»‘ $(C)$ cÃ³ má»™t tiá»‡m cáº­n ngang.", "a": false},
{"text": "Äá»“ thá»‹ hÃ m sá»‘ $(C)$ cÃ³ tiá»‡m cáº­n Ä‘á»©ng lÃ  $x=1$.", "a": true},
{"text": "Náº¿u Ä‘á»“ thá»‹ $(C)$ cÃ³ tiá»‡m cáº­n xiÃªn lÃ  $y=ax+b$ thÃ¬ $b=-1$.", "a": true},
{"text": "Giao Ä‘iá»ƒm cá»§a cÃ¡c Ä‘Æ°á»ng tiá»‡m cáº­n cá»§a Ä‘á»“ thá»‹ $(C)$ lÃ  $I(1;0)$.", "a": true}
]
},
{
"part": "Phan II: Cau trac nghiem dung sai",
"type": "true-false",
"question": "Cho hÃ m sá»‘ : $$y=-3{{x}^{3}}+5{{x}^{2}}-x-2$$  cÃ³ Ä‘á»“ thá»‹ lÃ  $\\left(\\text{C} \\right)$.",
"s": [
{"text": "Äá»“ thá»‹ hÃ m sá»‘ cÃ³ 2 Ä‘iá»ƒm cá»±c trá»‹.", "a": true},
{"text": "Äiá»ƒm Ä‘á»‘i xá»©ng cá»§a Ä‘á»“ thá»‹ cÃ³ tá»a Ä‘á»™ lÃ  $\\left(0;\\,2 \\right)$.", "a": false},
{"text": "TrÃªn Ä‘oáº¡n $\\left[ 1;3 \\right]$ thÃ¬ giÃ¡ trá»‹ lá»›n nháº¥t cá»§a hÃ m sá»‘ Ä‘áº¡t Ä‘Æ°á»£c táº¡i $x=1.$", "a": true},
{"text": "PhÆ°Æ¡ng trÃ¬nh tiáº¿p tuyáº¿n cÃ³ há»‡ sá»‘ gÃ³c lá»›n nháº¥t cá»§a Ä‘á»“ thá»‹ $\\left(\\text{C} \\right)$ Ä‘i qua Ä‘iá»ƒm $A\\left(2;3 \\right)$.", "a": false}
]
},
{
"part": "Phan II: Cau trac nghiem dung sai",
"type": "true-false",
"question": "Cho hÃ m sá»‘ $y=f\\left(x \\right)=a{{x}^{3}}+b{{x}^{2}}+cx+d$ cÃ³ Ä‘á»“ thá»‹ nhÆ° hÃ¬nh váº½ dÆ°á»›i Ä‘Ã¢y. <br> <img src=\"https://raw.githubusercontent.com/NVH2020/Anhbaithi/main/02.03.02.png\" alt=\"Äá»“ thá»‹ hÃ m sá»‘\" class=\"mx-auto my-3 rounded-lg shadow-md max-w-full\">  <br> Má»—i má»‡nh Ä‘á» sau Ä‘Ã¢y Ä‘Ãºng hay sai?",
"s": [
{"text": "$2a+3b+c=9$.", "a": false},
{"text": "Äá»“ thá»‹ hÃ m sá»‘ cáº¯t trá»¥c $Oy$ táº¡i Ä‘iá»ƒm cÃ³ toáº¡ Ä‘á»™ $\\left(0\\,;\\,1 \\right)$.", "a": true},
{"text": "HÃ m sá»‘ Ä‘áº¡t cá»±c tiá»ƒu táº¡i $x=1$.", "a": false},
{"text": "HÃ m sá»‘ Ä‘á»“ng biáº¿n trÃªn khoáº£ng $\\left(-\\infty \\,;\\,-1 \\right)$.", "a": false}
]
},
{
"part": "Phan III: Cau tra loi ngan",
"type": "short-answer",
"question": "Gá»i $M$ vÃ  $m$ láº§n lÆ°á»£t lÃ  giÃ¡ trá»‹ lá»›n nháº¥t vÃ  giÃ¡ trá»‹ nhá» nháº¥t cá»§a hÃ m sá»‘  $y={{x}^{3}}-3{{x}^{2}}-9x+35$  trÃªn Ä‘oáº¡n  $\\left[ -4;4 \\right]$ .TÃ­nh $2M+3m$.",
"a": "-43"
},
{
"part": "Phan III: Cau tra loi ngan",
"type": "short-answer",
"question": "Äá»ƒ thiáº¿t káº¿ má»™t chiáº¿c bá»ƒ cÃ¡ hÃ¬nh há»™p chá»¯ nháº­t khÃ´ng náº¯p cÃ³ chiá»u cao lÃ  $70cm$, thá»ƒ tÃ­ch lÃ  $112000c{{m}^{3}}$, ngÆ°á»i thá»£ dÃ¹ng loáº¡i kÃ­nh Ä‘á»ƒ sá»­ dá»¥ng lÃ m máº·t bÃªn cÃ³ giÃ¡ thÃ nh má»—i mÃ©t vuÃ´ng lÃ  $70000$ Ä‘á»“ng vÃ  loáº¡i kÃ­nh Ä‘á»ƒ lÃ m máº·t Ä‘Ã¡y cÃ³ giÃ¡ thÃ nh má»—i mÃ©t vuÃ´ng lÃ  $100000$ Ä‘á»“ng. Chi phÃ­ tháº¥p nháº¥t Ä‘á»ƒ hoÃ n thÃ nh bá»ƒ cÃ¡ lÃ  bao nhiÃªu nghÃ¬n Ä‘á»“ng?",
"a": "94,4"
},
{
"part": "Phan III: Cau tra loi ngan",
"type": "short-answer",
"question": "NgÆ°á»i ta giÄƒng lÆ°á»›i Ä‘á»ƒ nuÃ´i riÃªng má»™t loáº¡i cÃ¡ trÃªn má»™t gÃ³c há»“. Biáº¿t ráº±ng lÆ°á»›i Ä‘Æ°á»£c giÄƒng theo má»™t Ä‘Æ°á»ng tháº³ng tá»« má»™t vá»‹ trÃ­ trÃªn bá» ngang Ä‘áº¿n má»™t vá»‹ trÃ­ trÃªn bá» dá»c vÃ  pháº£i Ä‘i qua má»™t cÃ¡i cá»c Ä‘Ã£ cáº¯m sáºµn á»Ÿ vá»‹ trÃ­ $A$. Diá»‡n tÃ­ch nhá» nháº¥t cÃ³ thá»ƒ giÄƒng lÆ°á»›i lÃ  bao nhiÃªu mÃ©t vuÃ´ng, biáº¿t ráº±ng khoáº£ng cÃ¡ch tá»« cá»c Ä‘áº¿n bá» ngang lÃ  $5m$ vÃ  khoáº£ng cÃ¡ch tá»« cá»c Ä‘áº¿n bá» dá»c lÃ  $10m$? <br> <img src=\"https://raw.githubusercontent.com/NVH2020/Anhbaithi/main/03.03.02.png\" alt=\"Äá»“ thá»‹ hÃ m sá»‘\" class=\"mx-auto my-3 rounded-lg shadow-md max-w-full\">  ",
"a": "100"
},
{
"part": "Phan III: Cau tra loi ngan",
"type": "short-answer",
"question": "Cho hÃ m sá»‘ $y=\\frac{2{{x}^{2}}-3x-3}{x-2}$. Tiá»‡m cáº­n xiÃªn cá»§a Ä‘á»“ thá»‹ hÃ m sá»‘ lÃ  Ä‘Æ°á»ng tháº³ng $y=ax+b$. TÃ­nh giÃ¡ trá»‹ cá»§a biá»ƒu thá»©c $P={{a}^{2}}+{{b}^{2}}$.",
"a": "5"
}
];


let quizData = [];
const totalQuestions = originalQuizData.length;
document.getElementById("total-questions-display").textContent = totalQuestions;

// ========== Tráº¡ng thÃ¡i thi ==========
let currentUser = null;
let quizStartTime = null;
let timerInterval = null;
let timeLeftSeconds = TIME_LIMIT_SECONDS;
let currentQuestionIndex = 0;
let userAnswers = new Array(totalQuestions).fill(null);

// === Utility ===
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}
function prepareShuffledQuiz() {
    // Giá»¯ phÃ¢n loáº¡i theo 'part' giá»‘ng gá»‘c, nhÆ°ng shuffle trong má»—i part
    const grouped = originalQuizData.reduce((acc, q) => {
        acc[q.part] = acc[q.part] || [];
        acc[q.part].push(q);
        return acc;
    }, {});
    let res = [];
    for (const part in grouped) {
        shuffleArray(grouped[part]);
        res = res.concat(grouped[part]);
    }
    return res;
}

// ========== Kiá»ƒm tra sá»‘ láº§n thi trÆ°á»›c khi vÃ o ==========
startBtn.addEventListener("click", async () => {
    const now = new Date();
    const startDate = new Date(START_TIME);
    const endDate = new Date(DEADLINE);

    if (now < startDate) {
        alert(`BÃ i kiá»ƒm tra chá»‰ má»Ÿ tá»« ${startDate.toLocaleString('vi-VN')}. Vui lÃ²ng quay láº¡i sau.`);
        return;
    }
    if (now > endDate) {
        alert(`BÃ i kiá»ƒm tra Ä‘Ã£ káº¿t thÃºc vÃ o lÃºc ${endDate.toLocaleString('vi-VN')}. KhÃ´ng thá»ƒ nháº­n thÃªm bÃ i lÃ m.`);
        return;
    }

    const studentId = document.getElementById("studentId").value.trim();
    const fullname = document.getElementById("fullname").value.trim();
    const className = document.getElementById("className").value.trim();
    const school = document.getElementById("schoolInput").value.trim();


    if (!studentId || !fullname || !className || !school) {
        alert("Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin!");
        return;
    }

    // Kiá»ƒm tra sá»‘ láº§n lÃ m bÃ i vá»›i Firestore
    try {
        const resultsRef = collection(db, "quizResults");
        const q = query(resultsRef,
            where("studentId", "==", studentId),
            where("examCode", "==", EXAM_CODE),
            where("quizId", "==", QUIZ_ID)
        );
        const snapshot = await getDocs(q);
        if (snapshot.size >= ATTEMPT_LIMIT) {
            alert(`Sá»‘ bÃ¡o danh ${studentId} Ä‘Ã£ háº¿t sá»‘ lÆ°á»£t lÃ m bÃ i (${ATTEMPT_LIMIT} láº§n).`);
            return;
        }
    } catch (err) {
        console.error("Lá»—i kiá»ƒm tra lÆ°á»£t thi:", err);
        alert("Lá»—i kiá»ƒm tra sá»‘ lÆ°á»£t thi. Vui lÃ²ng thá»­ láº¡i hoáº·c kiá»ƒm tra káº¿t ná»‘i.");
        return;
    }

    // lÆ°u thÃ´ng tin táº¡m vÃ  hiá»‡n modal quáº£ng cÃ¡o
    currentUser = { examCode: EXAM_CODE, studentId, fullname, className, school };
    announcementModal.classList.remove("hidden");
});

// ========== VÃ o thi sau modal ==========
enterQuizBtn.addEventListener("click", () => {
    announcementModal.classList.add("hidden");
    userInfoSection.classList.add("hidden");
    quizSection.classList.remove("hidden");

    // chuáº©n bá»‹ Ä‘á», biáº¿n tráº¡ng thÃ¡i
    quizData = prepareShuffledQuiz();
    userAnswers = new Array(totalQuestions).fill(null);
    currentQuestionIndex = 0;
    quizStartTime = Date.now();
    timeLeftSeconds = TIME_LIMIT_SECONDS;

    renderNavPanel();
    jumpToQuestion(0);
    startTimer();
});

exitBtn.addEventListener("click", () => {
    announcementModal.classList.add("hidden");
});

// ========== Timer lÃ m bÃ i ==========
function startTimer() {
    // hiá»ƒn thá»‹ láº§n Ä‘áº§u
    updateTimerDisplay(timeLeftSeconds);

    // clear náº¿u cÃ²n
    if (timerInterval) clearInterval(timerInterval);

    timerInterval = setInterval(() => {
        timeLeftSeconds--;
        if (timeLeftSeconds <= 0) {
            clearInterval(timerInterval);
            // tá»± Ä‘á»™ng ná»™p mÃ  KHÃ”NG hiá»ƒn thá»‹ confirm
            alert("â° Háº¿t giá»! BÃ i thi sáº½ Ä‘Æ°á»£c ná»™p tá»± Ä‘á»™ng.");
            submitQuiz(true); // auto = true
        } else {
            updateTimerDisplay(timeLeftSeconds);
        }
    }, 1000);
}
function updateTimerDisplay(seconds) {
    const min = Math.floor(seconds / 60).toString().padStart(2, '0');
    const sec = (seconds % 60).toString().padStart(2, '0');
    timerElement.textContent = `${min}:${sec}`;
}

// ========== Äiá»u hÆ°á»›ng cÃ¢u há»i ==========
function renderNavPanel() {
    questionNavPanel.innerHTML = '';
    for (let i = 0; i < totalQuestions; i++) {
        const btn = document.createElement('button');
        btn.textContent = i + 1;
        btn.className = 'nav-btn w-10 h-10 border rounded font-medium';
        btn.type = 'button';
        btn.onclick = () => {
            saveCurrentAnswer();
            jumpToQuestion(i);
        };
        questionNavPanel.appendChild(btn);
    }
}
function jumpToQuestion(index) {
    currentQuestionIndex = index;
    showQuestion();
    updateNavPanel();
}
function showQuestion() {
    const q = quizData[currentQuestionIndex];
    document.getElementById("quiz-part-title").textContent = q.part || "";
    document.getElementById("question-counter").textContent = currentQuestionIndex + 1;
    document.getElementById("question-text").innerHTML = q.question || "";
    answerContainer.innerHTML = "";

    switch (q.type) {
        case 'mcq': renderMCQ(q); break;
        case 'true-false': renderTrueFalse(q); break;
        case 'short-answer': renderShortAnswer(q); break;
        default: renderMCQ(q);
    }

    if (window.MathJax && MathJax.typesetPromise) {
        MathJax.typesetPromise();
    }

    prevBtn.classList.toggle('hidden', currentQuestionIndex === 0);
    nextBtn.classList.toggle('hidden', currentQuestionIndex === totalQuestions - 1);
}
function updateNavPanel() {
    const navs = questionNavPanel.children;
    for (let i = 0; i < navs.length; i++) {
        navs[i].classList.remove('nav-btn-current', 'nav-btn-answered');
        if (userAnswers[i] !== null) navs[i].classList.add('nav-btn-answered');
        if (i === currentQuestionIndex) navs[i].classList.add('nav-btn-current');
    }
}

// ========== LÆ°u Ä‘Ã¡p Ã¡n khi chuyá»ƒn cÃ¢u ==========
function saveCurrentAnswer() {
    const q = quizData[currentQuestionIndex];
    if (!q) return;
    let ans = null;
    switch (q.type) {
        case 'mcq':
            const sr = quizForm.querySelector(`input[name="q${currentQuestionIndex}"]:checked`);
            if (sr) ans = sr.value;
            break;
        case 'true-false':
            ans = [];
            for (let i = 0; i < q.s.length; i++) {
                const sr2 = quizForm.querySelector(`input[name="q${currentQuestionIndex}s${i}"]:checked`);
                ans.push(sr2 ? (sr2.value === 'true') : null);
            }
            if (ans.every(x => x === null)) ans = null;
            break;
        case 'short-answer':
            const inp = quizForm.querySelector(`input[name="q${currentQuestionIndex}"]`);
            if (inp && inp.value.trim() !== "") ans = inp.value.trim();
            break;
    }
    userAnswers[currentQuestionIndex] = ans;
    updateNavPanel();
}

// ========== Render cÃ¡c loáº¡i cÃ¢u há»i ==========
function renderMCQ(question) {
    const saved = userAnswers[currentQuestionIndex];
    const options = [...question.o];
    options.forEach(option => {
        const div = document.createElement('div');
        const label = document.createElement('label');
        label.className = "flex items-center p-3 rounded-lg border cursor-pointer hover:bg-gray-50";

        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = `q${currentQuestionIndex}`;
        radio.value = option;
        radio.className = 'mr-3';
        if (saved === option) {
            radio.checked = true;
            label.classList.add('mcq-label-selected');
        }
        radio.addEventListener('change', () => {
            answerContainer.querySelectorAll('label').forEach(l => l.classList.remove('mcq-label-selected'));
            label.classList.add('mcq-label-selected');
            saveCurrentAnswer();
        });

        const span = document.createElement('span');
        span.innerHTML = option;

        label.appendChild(radio);
        label.appendChild(span);
        div.appendChild(label);
        answerContainer.appendChild(div);
    });
}

function renderTrueFalse(question) {
    const saved = userAnswers[currentQuestionIndex] || [];
    question.s.forEach((st, sIndex) => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-3 border rounded-lg';

        const span = document.createElement('span');
        span.innerHTML = st.text;

        const group = document.createElement('div');
        group.className = 'flex gap-4';

        const trueLabel = document.createElement('label');
        trueLabel.className = 'cursor-pointer flex items-center';
        const tRadio = document.createElement('input');
        tRadio.type = 'radio';
        tRadio.name = `q${currentQuestionIndex}s${sIndex}`;
        tRadio.value = 'true';
        tRadio.className = 'mr-2';
        if (saved[sIndex] === true) tRadio.checked = true;
        tRadio.addEventListener('change', saveCurrentAnswer);
        trueLabel.appendChild(tRadio);
        trueLabel.append(' ÄÃºng');

        const falseLabel = document.createElement('label');
        falseLabel.className = 'cursor-pointer flex items-center';
        const fRadio = document.createElement('input');
        fRadio.type = 'radio';
        fRadio.name = `q${currentQuestionIndex}s${sIndex}`;
        fRadio.value = 'false';
        fRadio.className = 'mr-2';
        if (saved[sIndex] === false) fRadio.checked = true;
        fRadio.addEventListener('change', saveCurrentAnswer);
        falseLabel.appendChild(fRadio);
        falseLabel.append(' Sai');

        group.appendChild(trueLabel);
        group.appendChild(falseLabel);
        div.appendChild(span);
        div.appendChild(group);
        answerContainer.appendChild(div);
    });
}

function renderShortAnswer(question) {
    const saved = userAnswers[currentQuestionIndex] || '';
    const input = document.createElement('input');
    input.type = 'text';
    input.name = `q${currentQuestionIndex}`;
    input.className = 'w-full border rounded px-3 py-2 mt-2';
    input.placeholder = "Nháº­p Ä‘Ã¡p Ã¡n";
    input.value = saved;
    input.addEventListener('input', saveCurrentAnswer);
    answerContainer.appendChild(input);
}

// ========== Äiá»u khiá»ƒn prev/next ==========
prevBtn.addEventListener('click', () => {
    saveCurrentAnswer();
    if (currentQuestionIndex > 0) jumpToQuestion(currentQuestionIndex - 1);
});
nextBtn.addEventListener('click', () => {
    saveCurrentAnswer();
    if (currentQuestionIndex < totalQuestions - 1) jumpToQuestion(currentQuestionIndex + 1);
});

// ========== Xá»­ lÃ½ ná»™p bÃ i (cÃ³ modal confirm) ==========
let isAutoSubmit = false; // náº¿u gá»i bá»Ÿi timeout thÃ¬ true

quizForm.addEventListener("submit", (e) => {
    e.preventDefault();
    // Náº¿u Ä‘ang auto-submit do háº¿t giá» thÃ¬ submit ngay
    if (isAutoSubmit) {
        isAutoSubmit = false;
        submitQuiz(true);
        return;
    }
    // else show confirm modal
    confirmSubmitModal.classList.remove('hidden');
});

// khi user xÃ¡c nháº­n Yes
confirmYes.addEventListener('click', () => {
    confirmSubmitModal.classList.add('hidden');
    submitQuiz(false);
});
confirmNo.addEventListener('click', () => {
    confirmSubmitModal.classList.add('hidden');
    // khÃ´ng ná»™p
});

// submitQuiz thá»±c táº¿ (auto=true khi do háº¿t giá»)
async function submitQuiz(auto = false) {
    // lÆ°u answer hiá»‡n táº¡i
    saveCurrentAnswer();
    if (timerInterval) clearInterval(timerInterval);

    // tÃ­nh thá»i gian lÃ m bÃ i
    const timeTakenSeconds = Math.round((Date.now() - quizStartTime) / 1000);
    // tÃ­nh Ä‘iá»ƒm (theo logic cÅ©)
    let totalScore = 0;
    const answersToSave = {};
    quizData.forEach((q, idx) => {
        const ua = userAnswers[idx];
        answersToSave[`q${idx+1}`] = ua;
        if (ua === null) return;
        switch (q.type) {
            case 'mcq':
                if (ua === q.a) totalScore += 0.5;
                break;
            case 'true-false':
                let correctCount = 0;
                q.s.forEach((st, sIndex) => { if (ua[sIndex] === st.a) correctCount++; });
                const pointsMap = [0, 0.1, 0.25, 0.5, 1];
                totalScore += pointsMap[correctCount] || 0;
                break;
            case 'short-answer':
                if (typeof ua === 'string' && ua.toLowerCase() === String(q.a).toLowerCase()) totalScore += 0.5;
                break;
        }
    });

    // áº©n quiz, hiá»‡n káº¿t quáº£
    quizSection.classList.add('hidden');
    resultSection.classList.remove('hidden');
    document.getElementById("studentNameResult").textContent = currentUser.fullname || "";

    document.getElementById("finalScore").textContent = totalScore.toFixed(2);

    // lÆ°u lÃªn Firestore
    try {
        await addDoc(collection(db, "quizResults"), {
            ...currentUser,
            quizId: QUIZ_ID,
            examCode: EXAM_CODE,
            score: parseFloat(totalScore.toFixed(2)),
            totalPossibleScore: totalQuestions * 0.5, // giáº£ sá»­ má»—i cÃ¢u 0.5 max
            timeTaken: timeTakenSeconds,
            answers: answersToSave,
            submittedAt: serverTimestamp()
        });
    } catch (err) {
        console.error("Lá»—i khi lÆ°u káº¿t quáº£:", err);
        alert("ÄÃ£ cÃ³ lá»—i khi lÆ°u káº¿t quáº£. Vui lÃ²ng thá»­ láº¡i hoáº·c liÃªn há»‡ quáº£n trá»‹.");
    }
}

// Náº¿u timer háº¿t giá» gá»i submitQuiz(true)
function autoSubmitNow() {
    isAutoSubmit = true;
    quizForm.requestSubmit(); // sáº½ trigger submit listener vÃ  auto xá»­ lÃ½
}

// ========== Khá»Ÿi táº¡o vÃ¹ng answerContainer tham chiáº¿u ==========
const answerContainer = document.getElementById("answer-container");
const questionNavPanel = document.getElementById("questionNavPanel");

// === khi Ä‘Ã³ng trang dá»n dáº¹p ===
window.addEventListener('beforeunload', () => {
    if (timerInterval) clearInterval(timerInterval);
});
</script>
</body>
</html>
