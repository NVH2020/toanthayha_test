<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>To√°n Th·∫ßy H√† - Toan10_002</title>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script>
window.MathJax = { tex:{ inlineMath:[['$','$'],['\\(','\\)']], displayMath:[['$$','$$'],['\\[','\\]']] } };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.nav-btn{transition:background-color .2s,color .2s,border-color .2s}
.nav-btn-answered{background:#16a34a;color:#fff;border-color:#15803d}
.nav-btn-current{background:#4f46e5;color:#fff;border-color:#4338ca;transform:scale(1.05)}
.mcq-label-selected{background:#e0e7ff;border-color:#6366f1}
@keyframes blinkingColors{0%,100%{color:#22c55e}33%{color:#ef4444}66%{color:#eab308}}
.blinking-text{animation:blinkingColors 3s infinite}
</style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div id="main-container" class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6">
    <h1 class="text-2xl font-bold text-center mb-6 blinking-text">L·ªõp To√°n Th·∫ßy H√†</h1>
    <div id="userInfoSection" class="max-w-md mx-auto">
      <div class="mb-4">
        <label class="block font-bold text-center text-blue-600">M√£ k·ª≥ thi (Ki·ªÉm tra)</label>
        <p id="examCodeDisplay" class="w-full text-center text-lg font-bold text-red-600 p-2 mt-1"></p>
      </div>
      <h2 class="text-xl font-bold text-center mb-4">Th√¥ng tin th√≠ sinh</h2>
      <div class="mb-3"><label class="block font-medium">S·ªë b√°o danh (V√≠ d·ª•: 530112, ch·ªù v√†i gi√¢y nh√©)</label><input type="text" id="studentId" class="w-full border rounded px-3 py-2 mt-1" required></div>
      <div class="mb-3"><label class="block font-medium">H·ªç v√† t√™n (T·ª± ƒëi·ªÅn)</label><input type="text" id="fullname" class="w-full border rounded px-3 py-2 mt-1" readonly required></div>
      <div class="mb-3"><label class="block font-medium">L·ªõp (T·ª± ƒëi·ªÅn)</label><input type="text" id="className" class="w-full border rounded px-3 py-2 mt-1" readonly required></div>
      <div class="mb-3">
        <label class="block font-medium">Tr∆∞·ªùng (T·ª± ƒëi·ªÅn ho·∫∑c nh·∫≠p tay)</label>
        <select id="schoolSelect" class="w-full border rounded px-3 py-2 mt-1">
          <option value="">-- Ch·ªçn tr∆∞·ªùng --</option>
          <option value="THPT Y√™n D≈©ng s·ªë 1">THPT Y√™n D≈©ng s·ªë 1</option>
          <option value="THPT Y√™n D≈©ng s·ªë 2">THPT Y√™n D≈©ng s·ªë 2</option>
          <option value="THPT Y√™n D≈©ng s·ªë 3">THPT Y√™n D≈©ng s·ªë 3</option>
          <option value="Kh√°c">Kh√°c...</option>
        </select>
        <input type="text" id="schoolInput" class="w-full border rounded px-3 py-2 mt-2 hidden" placeholder="Nh·∫≠p t√™n tr∆∞·ªùng kh√°c">
      </div>
      <button id="startBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded mt-2">B·∫Øt ƒë·∫ßu l√†m b√†i</button>
    </div>

    <div id="quizSection" class="hidden">
      <div id="quiz-header" class="flex justify-between items-start border-b pb-4 mb-4">
        <div>
          <h2 id="quiz-part-title" class="text-xl md:text-2xl font-bold text-gray-800"></h2>
          <p class="text-lg font-semibold text-blue-600">C√¢u <span id="question-counter">1</span> / <span id="total-questions-display"></span></p>
        </div>
        <div><div id="timer" class="text-2xl font-bold text-red-500">00:00</div><div id="timeHint" class="text-sm text-gray-500 text-right">Th·ªùi gian l√†m b√†i</div></div>
      </div>

      <div id="questionNavPanel" class="flex flex-wrap gap-2 p-3 border-b mb-4 bg-gray-50 rounded-lg"></div>

      <form id="quizForm" class="space-y-6">
        <p id="question-text" class="text-lg font-medium text-gray-800 min-h-[48px]"></p>
        <div id="answer-container" class="space-y-3"></div>

        <div class="flex justify-between items-center pt-4 mt-4 border-t">
          <button type="button" id="prevBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded">C√¢u tr∆∞·ªõc</button>
          <div class="flex gap-3">
            <button type="button" id="reviewTimeBtn" class="bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-2 rounded">Xem b·ªô th·ªùi gian</button>
            <button type="submit" id="submitBtn" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded text-lg font-bold">N·ªôp b√†i</button>
          </div>
          <button type="button" id="nextBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded">C√¢u sau</button>
        </div>
      </form>
    </div>

    <div id="countdown" class="text-red-600 font-bold text-lg my-2"></div>

    <div id="resultSection" class="hidden text-center">
      <h2 id="studentNameResult" class="text-2xl font-bold mb-2"></h2>
      <p class="text-lg mb-4">ƒê√£ ho√†n th√†nh b√†i ki·ªÉm tra!</p>
      <p class="text-blue-600 font-bold text-lg my-2">T·ªïng ƒëi·ªÉm c·ªßa b·∫°n l√†: <span id="finalScore" class="font-bold text-blue-600 text-3xl"></span></p>
      <p class="mt-4 text-gray-600">K·∫øt qu·∫£ ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o h·ªá th·ªëng.</p>
      <p class="text-red-600 font-bold text-lg my-2">Nh√≥m ti·∫øp t·ª•c tuy·ªÉn sinh. Vui l√≤ng li√™n h·ªá: 0988.948.882 <span id="finalScore" class="font-bold text-blue-600 text-3xl"></span></p>
    </div>

    <!-- Modal qu·∫£ng c√°o / x√°c nh·∫≠n v√†o thi -->
    <div id="announcementModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
      <div class="bg-white rounded-xl shadow-lg p-8 max-w-lg w-full text-center">
        <h2 class="text-xl font-bold mb-2">Th√¥ng b√°o</h2>
        <p class="text-gray-600 mb-6">B·∫°n s·∫Øp v√†o l√†m b√†i. Ki·ªÉm tra k·ªπ th√¥ng tin tr∆∞·ªõc khi v√†o thi.</p>
        <div class="flex justify-center gap-4">
          <button id="enterQuizBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-2 rounded">V√†o thi</button>
          <button id="exitBtn" class="bg-red-500 hover:bg-red-600 text-white px-8 py-2 rounded">Tho√°t</button>
        </div>
      </div>
    </div>

    <!-- Modal confirm n·ªôp b√†i -->
    <div id="confirmSubmitModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full text-center">
        <h3 class="text-lg font-bold mb-3">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i kh√¥ng?</h3>
        <p class="mb-4 text-gray-600">Sau khi n·ªôp, b·∫°n kh√¥ng th·ªÉ s·ª≠a ƒë√°p √°n.</p>
        <div class="flex justify-center gap-4">
          <button id="confirmYes" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded">Yes</button>
          <button id="confirmNo" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded">No</button>
        </div>
      </div>
    </div>

    <!-- Modal xem b·ªô th·ªùi gian -->
    <div id="timeInfoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
        <h3 class="text-lg font-bold mb-3">B·ªô th·ªùi gian</h3>
        <p class="mb-2"><strong>M√£ k·ª≥ thi:</strong> <span id="modalExamCode"></span></p>
        <p class="mb-2"><strong>Gi·ªù m·ªü ƒë·ªÅ:</strong> <span id="modalStartTime"></span></p>
        <p class="mb-2"><strong>Gi·ªù ƒë√≥ng ƒë·ªÅ:</strong> <span id="modalDeadline"></span></p>
        <div class="text-right"><button id="closeTimeInfo" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">ƒê√≥ng</button></div>
      </div>
    </div>
  </div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ===== Firebase (gi·ªØ nguy√™n) =====
const firebaseConfig = {
  apiKey: "AIzaSyAwM9_H8PTooz3Nh4MPt9wdtBScIvMC318",
  authDomain: "toanthayha-cd96c.firebaseapp.com",
  projectId: "toanthayha-cd96c",
  storageBucket: "toanthayha-cd96c.firebasestorage.app",
  messagingSenderId: "940207284081",
  appId: "1:940207284081:web:9801158f72cc14053ae0d0",
  measurementId: "G-9D5ZQ66BSB"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== C·∫•u h√¨nh k·ª≥ thi =====
const EXAM_CODE = "Toan10_002";
const QUIZ_ID = "toanthayha_10";
const API_URL = "https://script.google.com/macros/s/AKfycbzGkua7MT81r0F6A3RhCleOGR6gMGUtUkWcHwRWQYD8YBCINmzawoBW-d1SLN6weguQHg/exec";
const TIME_LIMIT_SECONDS = 60 * 60;
const ATTEMPT_LIMIT = 3;
const WARNING = 3;
const START_TIME = "2025-10-23T19:43";
const DEADLINE = "2025-10-25T20:43";
const SCORE_MCQ = 0.5;
const SCORE_SHORT = 0.5;
const POINTS_MAP_TF = [0,0.25,0.5,0.75,1];
document.getElementById("examHeader").textContent = "L·ªõp To√°n Th·∫ßy H√† _ " + EXAM_CODE;

const originalQuizData = [{"part":"Ph·∫ßn I","type":"mcq","question":"Gi√° tr·ªã c·ªßa $2^3$ l√† bao nhi√™u?","o":["6","8","9","12"],"a":"8"},{"part":"Ph·∫ßn II","type":"true-false","question":"ƒê√°nh gi√° c√°c ph√°t bi·ªÉu sau:","s":[{"text":"1+1=2","a":true},{"text":"5 l√† s·ªë ch·∫µn","a":false},{"text":"7 l√† s·ªë ch·∫µn","a":false},{"text":"6 l√† chia h·∫øt cho 5","a":false}]},{"part":"Ph·∫ßn III","type":"short-answer","question":"Vi·ªát Nam c√≤n bao nhi√™u t·ªânh, th√†nh ph·ªë","a":"34"}];

// ===== DOM & tr·∫°ng th√°i =====
const examCodeDisplay = document.getElementById("examCodeDisplay");
const startBtn = document.getElementById("startBtn");
const announcementModal = document.getElementById("announcementModal");
const enterQuizBtn = document.getElementById("enterQuizBtn");
const exitBtn = document.getElementById("exitBtn");
const userInfoSection = document.getElementById("userInfoSection");
const quizSection = document.getElementById("quizSection");
const resultSection = document.getElementById("resultSection");
const timerElement = document.getElementById("timer");
const countdownEl = document.getElementById("countdown");
const reviewTimeBtn = document.getElementById("reviewTimeBtn");
const confirmSubmitModal = document.getElementById("confirmSubmitModal");
const confirmYes = document.getElementById("confirmYes");
const confirmNo = document.getElementById("confirmNo");
const timeInfoModal = document.getElementById("timeInfoModal");
const modalExamCode = document.getElementById("modalExamCode");
const modalStartTime = document.getElementById("modalStartTime");
const modalDeadline = document.getElementById("modalDeadline");
const closeTimeInfo = document.getElementById("closeTimeInfo");
const quizForm = document.getElementById("quizForm");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const submitBtn = document.getElementById("submitBtn");

const studentIdInput = document.getElementById("studentId");
const fullnameInput = document.getElementById("fullname");
const classNameInput = document.getElementById("className");
const schoolSelect = document.getElementById("schoolSelect");
const schoolInput = document.getElementById("schoolInput");
const answerContainer = document.getElementById("answer-container");
const questionNavPanel = document.getElementById("questionNavPanel");
document.addEventListener("keydown", function (e) {
  if (e.key === "PrintScreen") {
    alert("Ch·ª•p m√†n h√¨nh kh√¥ng ƒë∆∞·ª£c ph√©p!");
    // L√†m m·ªù t·∫°m th·ªùi n·ªôi dung ƒë·ªÉ ch·ª•p ·∫£nh kh√¥ng th·∫•y r√µ
    document.body.style.filter = "blur(8px)";
    setTimeout(() => {
      document.body.style.filter = "none";
    }, 2000);
    e.preventDefault();
  }
});
document.addEventListener("visibilitychange", function () {
  if (document.hidden) {
    document.body.style.filter = "blur(15px)";
  } else {
    document.body.style.filter = "none";
  }
});
document.addEventListener("contextmenu", function(e) {
  e.preventDefault();
  alert("Chu·ªôt ph·∫£i ƒë√£ b·ªã v√¥ hi·ªáu h√≥a!");
});

document.addEventListener("keydown", function(e) {
  if (e.ctrlKey && (e.key === "s" || e.key === "p")) {
    alert("Kh√¥ng ƒë∆∞·ª£c l∆∞u ho·∫∑c in b√†i thi!");
    e.preventDefault();
  }
});

document.addEventListener("contextmenu", function(e) {
    e.preventDefault();
    alert("Chu·ªôt ph·∫£i ƒë√£ b·ªã v√¥ hi·ªáu h√≥a!");
});

examCodeDisplay.textContent = EXAM_CODE;
modalExamCode.textContent = EXAM_CODE;
modalStartTime.textContent = (new Date(START_TIME)).toLocaleString('vi-VN');
modalDeadline.textContent = (new Date(DEADLINE)).toLocaleString('vi-VN');
reviewTimeBtn.addEventListener("click", () => timeInfoModal.classList.remove("hidden"));
closeTimeInfo.addEventListener("click", () => timeInfoModal.classList.add("hidden"));

schoolSelect.addEventListener("change", () => {
  if (schoolSelect.value === "Kh√°c") {
    schoolInput.classList.remove("hidden");
    schoolInput.value = "";
  } else {
    schoolInput.classList.add("hidden");
    schoolInput.value = schoolSelect.value;
  }
});
let warningCount = 0;
document.addEventListener("visibilitychange", function() {
    if (document.hidden) {
        warningCount++;
        alert("‚ö†Ô∏è B·∫°n ƒë√£ r·ªùi kh·ªèi m√†n h√¨nh l√†m b√†i.S·ªë l·∫ßn c√≤n l·∫°i l√†:  " + (WARNING - warningCount));
        if (warningCount >= WARNING ) {
            alert("B·∫°n ƒë√£ vi ph·∫°m qu√° s·ªë l·∫ßn cho ph√©p. H·ªá th·ªëng s·∫Ω n·ªôp b√†i!");
            // H√†m autoSubmit() c·∫ßn vi·∫øt s·∫µn ƒë·ªÉ n·ªôp b√†i
            submitQuiz(true);
        }
    }
});

// Countdown
function formatDiff(ms) {
  if (ms < 0) ms = 0;
  const totalSeconds = Math.floor(ms/1000);
  const h = Math.floor(totalSeconds/3600);
  const m = Math.floor((totalSeconds%3600)/60);
  const s = totalSeconds%60;
  return h + "h " + m + "m " + s + "s";
}
// ===== Th√¥ng b√°o th·ªùi gian m·ªü, t·ªïng s·ªë l∆∞·ª£t l√†m, s·ªë th·ªùi gian c√≤n m·ªü ƒë·ªÉ
function updateCountdown() {
  const now = new Date();
  const startDate = new Date(START_TIME);
  const endDate = new Date(DEADLINE);
  let msg = "";
  if (now < startDate) {
    msg = "‚è≥ B√†i ki·ªÉm tra s·∫Ω m·ªü sau: " + formatDiff(startDate - now);
    startBtn.disabled = true;
  } else if (now <= endDate) {
    msg = "üìù B√†i ki·ªÉm tra ƒëang m·ªü. B·∫°n c√≥ t·∫•t c·∫£ " + ATTEMPT_LIMIT + " l∆∞·ª£t thi. C√≤n th·ªùi gian t·ªõi khi ƒë√≥ng ƒë·ªÅ " + formatDiff(endDate - now);
    startBtn.disabled = false;
  } else {
    msg = "‚ùå B√†i ki·ªÉm tra ƒë√£ k·∫øt th√∫c.";
    startBtn.disabled = true;
    startBtn.textContent = "ƒê√£ h·∫øt h·∫°n l√†m b√†i";
    startBtn.classList.add('bg-gray-400','cursor-not-allowed');
  }
  countdownEl.textContent = msg;
}
setInterval(updateCountdown, 1000);
updateCountdown();

// Utils
function shuffleArray(array){ for(let i=array.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [array[i],array[j]]=[array[j],array[i]]; } }
function prepareShuffledQuiz(){ const grouped = originalQuizData.reduce((acc,q)=>{ acc[q.part]=acc[q.part]||[]; acc[q.part].push(q); return acc; },{}); let res=[]; for(const p in grouped){ shuffleArray(grouped[p]); res=res.concat(grouped[p]); } return res; }

let quizData=[];
const totalQuestions = originalQuizData.length;
document.getElementById("total-questions-display").textContent = totalQuestions;

let currentUser = null;
let quizStartTime = null;
let timerInterval = null;
let timeLeftSeconds = TIME_LIMIT_SECONDS;
let currentQuestionIndex = 0;
let userAnswers = new Array(totalQuestions).fill(null);

// Start: ki·ªÉm tra th·ªùi gian & s·ªë l∆∞·ª£t thi
startBtn.addEventListener("click", async ()=>{
  const now = new Date();
  const startDate = new Date(START_TIME);
  const endDate = new Date(DEADLINE);
  if (now < startDate) { alert("B√†i ki·ªÉm tra ch∆∞a m·ªü."); return; }
  if (now > endDate) { alert("B√†i ki·ªÉm tra ƒë√£ ƒë√≥ng."); return; }

  const studentId = studentIdInput.value.trim();
  const fullname = fullnameInput.value.trim();
  const className = classNameInput.value.trim();
  let school = schoolSelect.value === "Kh√°c" ? schoolInput.value.trim() : schoolSelect.value;

  if (!studentId || !fullname || !className || !school) { alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!"); return; }

  // Ki·ªÉm tra s·ªë l∆∞·ª£t thi (Firestore)
  try {
    const resultsRef = collection(db, "quizResults");
    const q = query(resultsRef, where("studentId","==", studentId), where("examCode","==", EXAM_CODE), where("quizId","==", QUIZ_ID));
    const snap = await getDocs(q);
    if (snap.size >= ATTEMPT_LIMIT) {
      alert("B·∫°n ƒë√£ h·∫øt l∆∞·ª£t l√†m b√†i cho k·ª≥ thi n√†y.");
      return;
    }
  } catch(err){
    console.error("L·ªói ki·ªÉm tra l∆∞·ª£t thi:", err);
    alert("L·ªói khi ki·ªÉm tra l∆∞·ª£t thi. Vui l√≤ng th·ª≠ l·∫°i.");
    return;
  }

  currentUser = { examCode: EXAM_CODE, studentId, fullname, className, school };
  announcementModal.classList.remove("hidden");
});

document.getElementById("enterQuizBtn").addEventListener("click", ()=>{
  announcementModal.classList.add("hidden");
  userInfoSection.classList.add("hidden");
  quizSection.classList.remove("hidden");
  startQuiz();
});
document.getElementById("exitBtn").addEventListener("click", ()=> announcementModal.classList.add("hidden"));

function startQuiz(){
  quizData = prepareShuffledQuiz();
  userAnswers = new Array(totalQuestions).fill(null);
  currentQuestionIndex = 0;
  quizStartTime = Date.now();
  timeLeftSeconds = TIME_LIMIT_SECONDS;
  document.getElementById("total-questions-display").textContent = totalQuestions;
  renderNavPanel();
  jumpToQuestion(0);
  startTimer();
}

// Timer
function startTimer(){
  if (timerInterval) clearInterval(timerInterval);
  updateTimerDisplay(timeLeftSeconds);
  timerInterval = setInterval(()=>{
    timeLeftSeconds--;
    if (timeLeftSeconds <= 0) { clearInterval(timerInterval); alert("‚è∞ H·∫øt gi·ªù! B√†i thi s·∫Ω ƒë∆∞·ª£c n·ªôp t·ª± ƒë·ªông."); submitQuiz(true); }
    else updateTimerDisplay(timeLeftSeconds);
  }, 1000);
}
function updateTimerDisplay(sec){
  const m = Math.floor(sec/60).toString().padStart(2,'0');
  const s = (sec%60).toString().padStart(2,'0');
  timerElement.textContent = m + ":" + s;
}

// Render nav
function renderNavPanel(){
  questionNavPanel.innerHTML = '';
  for (let i=0;i<totalQuestions;i++){
    const btn = document.createElement('button');
    btn.textContent = i+1;
    btn.className = 'nav-btn w-10 h-10 border rounded font-medium';
    btn.type = 'button';
    btn.onclick = ()=>{ saveCurrentAnswer(); jumpToQuestion(i); };
    questionNavPanel.appendChild(btn);
  }
}
function jumpToQuestion(idx){
  currentQuestionIndex = idx;
  showQuestion();
  updateNavPanel();
}
function showQuestion(){
  const q = quizData[currentQuestionIndex];
  document.getElementById("quiz-part-title").textContent = q.part || "";
  document.getElementById("question-counter").textContent = currentQuestionIndex + 1;
  document.getElementById("question-text").innerHTML = q.question || "";
  answerContainer.innerHTML = "";
  switch(q.type){
    case 'mcq': renderMCQ(q); break;
    case 'true-false': renderTrueFalse(q); break;
    case 'short-answer': renderShortAnswer(q); break;
    default: renderMCQ(q);
  }
  if (window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise();
  prevBtn.classList.toggle('hidden', currentQuestionIndex === 0);
  nextBtn.classList.toggle('hidden', currentQuestionIndex === totalQuestions - 1);
}
function updateNavPanel(){
  const navs = questionNavPanel.children;
  for (let i=0;i<navs.length;i++){
    navs[i].classList.remove('nav-btn-current','nav-btn-answered');
    if (userAnswers[i] !== null) navs[i].classList.add('nav-btn-answered');
    if (i === currentQuestionIndex) navs[i].classList.add('nav-btn-current');
  }
}

// L∆∞u c√¢u tr·∫£ l·ªùi
function saveCurrentAnswer(){
  const q = quizData[currentQuestionIndex];
  if (!q) return;
  let ans = null;
  if (q.type === 'mcq'){
    const r = quizForm.querySelector('input[name="q'+currentQuestionIndex+'"]:checked');
    if (r) ans = r.value;
  } else if (q.type === 'true-false'){
    ans = [];
    for (let i=0;i<q.s.length;i++){
      const r = quizForm.querySelector('input[name="q'+currentQuestionIndex+'s'+i+'"]:checked');
      ans.push(r ? (r.value === 'true') : null);
    }
    if (ans.every(x => x === null)) ans = null;
  } else if (q.type === 'short-answer'){
    const inp = quizForm.querySelector('input[name="q'+currentQuestionIndex+'"]');
    if (inp && inp.value.trim() !== '') ans = inp.value.trim();
  }
  userAnswers[currentQuestionIndex] = ans;
  updateNavPanel();
}

// Render MCQ/TF/Short
function renderMCQ(question){
  const saved = userAnswers[currentQuestionIndex];
  const options = [...question.o];
  options.forEach(opt => {
    const div = document.createElement('div');
    const label = document.createElement('label');
    label.className = "flex items-center p-3 rounded-lg border cursor-pointer hover:bg-gray-50";
    const radio = document.createElement('input');
    radio.type = 'radio'; radio.name = 'q'+currentQuestionIndex; radio.value = opt; radio.className = 'mr-3';
    if (saved === opt) { radio.checked = true; label.classList.add('mcq-label-selected'); }
    radio.addEventListener('change', ()=> { answerContainer.querySelectorAll('label').forEach(l=>l.classList.remove('mcq-label-selected')); label.classList.add('mcq-label-selected'); saveCurrentAnswer(); });
    const span = document.createElement('span'); span.innerHTML = opt;
    label.appendChild(radio); label.appendChild(span); div.appendChild(label); answerContainer.appendChild(div);
  });
}
function renderTrueFalse(question){
  const saved = userAnswers[currentQuestionIndex] || [];
  question.s.forEach((st, idx) => {
    const div = document.createElement('div'); div.className = 'flex items-center justify-between p-3 border rounded-lg';
    const span = document.createElement('span'); span.innerHTML = st.text;
    const group = document.createElement('div'); group.className = 'flex gap-4';
    const trueLabel = document.createElement('label'); trueLabel.className='cursor-pointer flex items-center';
    const tRadio = document.createElement('input'); tRadio.type='radio'; tRadio.name='q'+currentQuestionIndex+'s'+idx; tRadio.value='true'; tRadio.className='mr-2';
    if (saved[idx] === true) tRadio.checked = true; tRadio.addEventListener('change', saveCurrentAnswer);
    trueLabel.appendChild(tRadio); trueLabel.append(' ƒê√∫ng');
    const falseLabel = document.createElement('label'); falseLabel.className='cursor-pointer flex items-center';
    const fRadio = document.createElement('input'); fRadio.type='radio'; fRadio.name='q'+currentQuestionIndex+'s'+idx; fRadio.value='false'; fRadio.className='mr-2';
    if (saved[idx] === false) fRadio.checked = true; fRadio.addEventListener('change', saveCurrentAnswer);
    falseLabel.appendChild(fRadio); falseLabel.append(' Sai');
    group.appendChild(trueLabel); group.appendChild(falseLabel);
    div.appendChild(span); div.appendChild(group); answerContainer.appendChild(div);
  });
}
function renderShortAnswer(question){
  const saved = userAnswers[currentQuestionIndex] || '';
  const input = document.createElement('input'); input.type='text'; input.name='q'+currentQuestionIndex;
  input.className = 'w-full border rounded px-3 py-2 mt-2'; input.placeholder = 'Nh·∫≠p ƒë√°p √°n'; input.value = saved;
  input.addEventListener('input', saveCurrentAnswer); answerContainer.appendChild(input);
}

// Prev/Next
prevBtn.addEventListener('click', ()=>{ saveCurrentAnswer(); if (currentQuestionIndex>0) jumpToQuestion(currentQuestionIndex-1); });
nextBtn.addEventListener('click', ()=>{ saveCurrentAnswer(); if (currentQuestionIndex<totalQuestions-1) jumpToQuestion(currentQuestionIndex+1); });

// Submit (modal confirm)
let isAutoSubmit = false;
quizForm.addEventListener('submit', (e)=> {
  e.preventDefault();
  if (isAutoSubmit) { isAutoSubmit = false; submitQuiz(true); return; }
  confirmSubmitModal.classList.remove('hidden');
});
confirmYes.addEventListener('click', ()=>{ confirmSubmitModal.classList.add('hidden'); submitQuiz(false); });
confirmNo.addEventListener('click', ()=>{ confirmSubmitModal.classList.add('hidden'); });

// Th·ª±c hi·ªán submit
async function submitQuiz(auto=false){
  saveCurrentAnswer();
  if (timerInterval) clearInterval(timerInterval);
  const timeTakenSeconds = Math.round((Date.now() - quizStartTime)/1000);
  let totalScore = 0;
  const answersToSave = {};
  quizData.forEach((q, idx) => {
    const ua = userAnswers[idx];
    answersToSave['q'+(idx+1)] = ua;
    if (ua === null) return;
    if (q.type === 'mcq') {
      if (ua === q.a) totalScore += SCORE_MCQ;
    } else if (q.type === 'true-false') {
      let correctCount = 0;
      q.s.forEach((st, sIdx) => { if (ua && ua[sIdx] === st.a) correctCount++; });
      totalScore += (POINTS_MAP_TF[correctCount] || 0);
    } else if (q.type === 'short-answer') {
      if (typeof ua === 'string' && ua.trim().toLowerCase() === String(q.a).trim().toLowerCase()) totalScore += SCORE_SHORT;
    }
  });
   
if (document.getElementById("quizSection")) {
  document.getElementById("quizSection").style.opacity = 0;
  setTimeout(()=>document.getElementById("quizSection").style.opacity=1,2000);
}


  quizSection.classList.add('hidden');
  resultSection.classList.remove('hidden');
  document.getElementById("studentNameResult").textContent = (currentUser && currentUser.fullname) ? currentUser.fullname : "";

  document.getElementById("finalScore").textContent = totalScore.toFixed(2);

  // L∆∞u l√™n Firestore
  try {
    await addDoc(collection(db, "quizResults"), {
      ...currentUser,
      quizId: QUIZ_ID,
      examCode: EXAM_CODE,
      score: parseFloat(totalScore.toFixed(2)),
      totalPossibleScore: totalQuestions * SCORE_MCQ,
      timeTaken: timeTakenSeconds,
      answers: answersToSave,
      warningCount: warningCount,
      submittedAt: serverTimestamp()
    });
  } catch (err) {
    console.error("L·ªói khi l∆∞u k·∫øt qu·∫£:", err);
    alert("ƒê√£ c√≥ l·ªói khi l∆∞u k·∫øt qu·∫£. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá qu·∫£n tr·ªã.");
  }
}

// Auto submit (khi h·∫øt gi·ªù)
function autoSubmitNow(){ isAutoSubmit = true; quizForm.requestSubmit(); }

// L·∫•y th√¥ng tin h·ªçc sinh t·ª´ Google Sheet Web App
studentIdInput.addEventListener('blur', async () => {
  const id = studentIdInput.value.trim();
  if (!id) return;
  try {
    const res = await fetch(API_URL + '?id=' + encodeURIComponent(id));
    const data = await res.json();
    if (data && data.studentId) {
      fullnameInput.value = data.fullname || '';
      classNameInput.value = data.className || '';
      const schoolVal = data.school || '';
      if (schoolSelect.querySelector('option[value="' + schoolVal + '"]')) {
        schoolSelect.value = schoolVal;
        schoolInput.classList.add('hidden');
      } else {
        schoolSelect.value = 'Kh√°c';
        schoolInput.classList.remove('hidden');
        schoolInput.value = schoolVal;
      }
    } else {
      alert('‚ùå Kh√¥ng t√¨m th·∫•y s·ªë b√°o danh n√†y trong danh s√°ch.');
      fullnameInput.value = '';
      classNameInput.value = '';
      schoolSelect.value = '';
      schoolInput.value = '';
    }
  } catch (err) {
    console.error('L·ªói l·∫•y d·ªØ li·ªáu:', err);
    alert('L·ªói k·∫øt n·ªëi t·ªõi Google Sheet. Vui l√≤ng th·ª≠ l·∫°i.');
  }
});

// Cleanup
window.addEventListener('beforeunload', ()=> { if (timerInterval) clearInterval(timerInterval); });


</script>
</body>
</html>
