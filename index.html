<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Toán Thầy Hà - Toan10_002</title>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script>
window.MathJax = { tex:{ inlineMath:[['$','$'],['\\(','\\)']], displayMath:[['$$','$$'],['\\[','\\]']] } };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
.nav-btn{transition:background-color .2s,color .2s,border-color .2s}
.nav-btn-answered{background:#16a34a;color:#fff;border-color:#15803d}
.nav-btn-current{background:#4f46e5;color:#fff;border-color:#4338ca;transform:scale(1.05)}
.mcq-label-selected{background:#e0e7ff;border-color:#6366f1}
@keyframes blinkingColors{0%,100%{color:#22c55e}33%{color:#ef4444}66%{color:#eab308}}
.blinking-text{animation:blinkingColors 3s infinite}
</style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div id="main-container" class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6">
    <h1 class="text-2xl font-bold text-center mb-6 blinking-text">Lớp Toán Thầy Hà</h1>
    <div id="userInfoSection" class="max-w-md mx-auto">
      <div class="mb-4">
        <label class="block font-bold text-center text-blue-600">Mã kỳ thi (Kiểm tra)</label>
        <p id="examCodeDisplay" class="w-full text-center text-lg font-bold text-red-600 p-2 mt-1"></p>
      </div>
      <h2 class="text-xl font-bold text-center mb-4">Thông tin thí sinh</h2>
      <div class="mb-3"><label class="block font-medium">Số báo danh (Ví dụ: 530112, chờ vài giây nhé)</label><input type="text" id="studentId" class="w-full border rounded px-3 py-2 mt-1" required></div>
      <div class="mb-3"><label class="block font-medium">Họ và tên (Tự điền)</label><input type="text" id="fullname" class="w-full border rounded px-3 py-2 mt-1" readonly required></div>
      <div class="mb-3"><label class="block font-medium">Lớp (Tự điền)</label><input type="text" id="className" class="w-full border rounded px-3 py-2 mt-1" readonly required></div>
      <div class="mb-3">
        <label class="block font-medium">Trường (Tự điền hoặc nhập tay)</label>
        <select id="schoolSelect" class="w-full border rounded px-3 py-2 mt-1">
          <option value="">-- Chọn trường --</option>
          <option value="THPT Yên Dũng số 1">THPT Yên Dũng số 1</option>
          <option value="THPT Yên Dũng số 2">THPT Yên Dũng số 2</option>
          <option value="THPT Yên Dũng số 3">THPT Yên Dũng số 3</option>
          <option value="Khác">Khác...</option>
        </select>
        <input type="text" id="schoolInput" class="w-full border rounded px-3 py-2 mt-2 hidden" placeholder="Nhập tên trường khác">
      </div>
      <button id="startBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded mt-2">Bắt đầu làm bài</button>
    </div>

    <div id="quizSection" class="hidden">
      <div id="quiz-header" class="flex justify-between items-start border-b pb-4 mb-4">
        <div>
          <h2 id="quiz-part-title" class="text-xl md:text-2xl font-bold text-gray-800"></h2>
          <p class="text-lg font-semibold text-blue-600">Câu <span id="question-counter">1</span> / <span id="total-questions-display"></span></p>
        </div>
        <div><div id="timer" class="text-2xl font-bold text-red-500">00:00</div><div id="timeHint" class="text-sm text-gray-500 text-right">Thời gian làm bài</div></div>
      </div>

      <div id="questionNavPanel" class="flex flex-wrap gap-2 p-3 border-b mb-4 bg-gray-50 rounded-lg"></div>

      <form id="quizForm" class="space-y-6">
        <p id="question-text" class="text-lg font-medium text-gray-800 min-h-[48px]"></p>
        <div id="answer-container" class="space-y-3"></div>

        <div class="flex justify-between items-center pt-4 mt-4 border-t">
          <button type="button" id="prevBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded">Câu trước</button>
          <div class="flex gap-3">
            <button type="button" id="reviewTimeBtn" class="bg-yellow-400 hover:bg-yellow-500 text-white px-4 py-2 rounded">Xem bộ thời gian</button>
            <button type="submit" id="submitBtn" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded text-lg font-bold">Nộp bài</button>
          </div>
          <button type="button" id="nextBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded">Câu sau</button>
        </div>
      </form>
    </div>

    <div id="countdown" class="text-red-600 font-bold text-lg my-2"></div>

    <div id="resultSection" class="hidden text-center">
      <h2 id="studentNameResult" class="text-2xl font-bold mb-2"></h2>
      <p class="text-lg mb-4">Đã hoàn thành bài kiểm tra!</p>
      <p class="text-blue-600 font-bold text-lg my-2">Tổng điểm của bạn là: <span id="finalScore" class="font-bold text-blue-600 text-3xl"></span></p>
      <p class="mt-4 text-gray-600">Kết quả đã được lưu vào hệ thống.</p>
      <p class="text-red-600 font-bold text-lg my-2">Nhóm tiếp tục tuyển sinh. Vui lòng liên hệ: 0988.948.882 <span id="finalScore" class="font-bold text-blue-600 text-3xl"></span></p>
    </div>

    <!-- Modal quảng cáo / xác nhận vào thi -->
    <div id="announcementModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
      <div class="bg-white rounded-xl shadow-lg p-8 max-w-lg w-full text-center">
        <h2 class="text-xl font-bold mb-2">Thông báo</h2>
        <p class="text-gray-600 mb-6">Bạn sắp vào làm bài. Kiểm tra kỹ thông tin trước khi vào thi.</p>
        <div class="flex justify-center gap-4">
          <button id="enterQuizBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-2 rounded">Vào thi</button>
          <button id="exitBtn" class="bg-red-500 hover:bg-red-600 text-white px-8 py-2 rounded">Thoát</button>
        </div>
      </div>
    </div>

    <!-- Modal confirm nộp bài -->
    <div id="confirmSubmitModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full text-center">
        <h3 class="text-lg font-bold mb-3">Bạn có chắc chắn muốn nộp bài không?</h3>
        <p class="mb-4 text-gray-600">Sau khi nộp, bạn không thể sửa đáp án.</p>
        <div class="flex justify-center gap-4">
          <button id="confirmYes" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded">Yes</button>
          <button id="confirmNo" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded">No</button>
        </div>
      </div>
    </div>

    <!-- Modal xem bộ thời gian -->
    <div id="timeInfoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
      <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full">
        <h3 class="text-lg font-bold mb-3">Bộ thời gian</h3>
        <p class="mb-2"><strong>Mã kỳ thi:</strong> <span id="modalExamCode"></span></p>
        <p class="mb-2"><strong>Giờ mở đề:</strong> <span id="modalStartTime"></span></p>
        <p class="mb-2"><strong>Giờ đóng đề:</strong> <span id="modalDeadline"></span></p>
        <div class="text-right"><button id="closeTimeInfo" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">Đóng</button></div>
      </div>
    </div>
  </div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// ===== Firebase (giữ nguyên) =====
const firebaseConfig = {
  apiKey: "AIzaSyAwM9_H8PTooz3Nh4MPt9wdtBScIvMC318",
  authDomain: "toanthayha-cd96c.firebaseapp.com",
  projectId: "toanthayha-cd96c",
  storageBucket: "toanthayha-cd96c.firebasestorage.app",
  messagingSenderId: "940207284081",
  appId: "1:940207284081:web:9801158f72cc14053ae0d0",
  measurementId: "G-9D5ZQ66BSB"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ===== Cấu hình kỳ thi =====
const EXAM_CODE = "Toan10_002";
const QUIZ_ID = "toanthayha_10";
const API_URL = "https://script.google.com/macros/s/AKfycbzGkua7MT81r0F6A3RhCleOGR6gMGUtUkWcHwRWQYD8YBCINmzawoBW-d1SLN6weguQHg/exec";
const TIME_LIMIT_SECONDS = 60 * 60;
const ATTEMPT_LIMIT = 3;
const WARNING = 3;
const START_TIME = "2025-10-23T19:43";
const DEADLINE = "2025-10-25T20:43";
const SCORE_MCQ = 0.5;
const SCORE_SHORT = 0.5;
const POINTS_MAP_TF = [0,0.25,0.5,0.75,1];
document.getElementById("examHeader").textContent = "Lớp Toán Thầy Hà _ " + EXAM_CODE;

const originalQuizData = [{"part":"Phần I","type":"mcq","question":"Giá trị của $2^3$ là bao nhiêu?","o":["6","8","9","12"],"a":"8"},{"part":"Phần II","type":"true-false","question":"Đánh giá các phát biểu sau:","s":[{"text":"1+1=2","a":true},{"text":"5 là số chẵn","a":false},{"text":"7 là số chẵn","a":false},{"text":"6 là chia hết cho 5","a":false}]},{"part":"Phần III","type":"short-answer","question":"Việt Nam còn bao nhiêu tỉnh, thành phố","a":"34"}];

// ===== DOM & trạng thái =====
const examCodeDisplay = document.getElementById("examCodeDisplay");
const startBtn = document.getElementById("startBtn");
const announcementModal = document.getElementById("announcementModal");
const enterQuizBtn = document.getElementById("enterQuizBtn");
const exitBtn = document.getElementById("exitBtn");
const userInfoSection = document.getElementById("userInfoSection");
const quizSection = document.getElementById("quizSection");
const resultSection = document.getElementById("resultSection");
const timerElement = document.getElementById("timer");
const countdownEl = document.getElementById("countdown");
const reviewTimeBtn = document.getElementById("reviewTimeBtn");
const confirmSubmitModal = document.getElementById("confirmSubmitModal");
const confirmYes = document.getElementById("confirmYes");
const confirmNo = document.getElementById("confirmNo");
const timeInfoModal = document.getElementById("timeInfoModal");
const modalExamCode = document.getElementById("modalExamCode");
const modalStartTime = document.getElementById("modalStartTime");
const modalDeadline = document.getElementById("modalDeadline");
const closeTimeInfo = document.getElementById("closeTimeInfo");
const quizForm = document.getElementById("quizForm");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const submitBtn = document.getElementById("submitBtn");

const studentIdInput = document.getElementById("studentId");
const fullnameInput = document.getElementById("fullname");
const classNameInput = document.getElementById("className");
const schoolSelect = document.getElementById("schoolSelect");
const schoolInput = document.getElementById("schoolInput");
const answerContainer = document.getElementById("answer-container");
const questionNavPanel = document.getElementById("questionNavPanel");
document.addEventListener("keydown", function (e) {
  if (e.key === "PrintScreen") {
    alert("Chụp màn hình không được phép!");
    // Làm mờ tạm thời nội dung để chụp ảnh không thấy rõ
    document.body.style.filter = "blur(8px)";
    setTimeout(() => {
      document.body.style.filter = "none";
    }, 2000);
    e.preventDefault();
  }
});
document.addEventListener("visibilitychange", function () {
  if (document.hidden) {
    document.body.style.filter = "blur(15px)";
  } else {
    document.body.style.filter = "none";
  }
});
document.addEventListener("contextmenu", function(e) {
  e.preventDefault();
  alert("Chuột phải đã bị vô hiệu hóa!");
});

document.addEventListener("keydown", function(e) {
  if (e.ctrlKey && (e.key === "s" || e.key === "p")) {
    alert("Không được lưu hoặc in bài thi!");
    e.preventDefault();
  }
});

document.addEventListener("contextmenu", function(e) {
    e.preventDefault();
    alert("Chuột phải đã bị vô hiệu hóa!");
});

examCodeDisplay.textContent = EXAM_CODE;
modalExamCode.textContent = EXAM_CODE;
modalStartTime.textContent = (new Date(START_TIME)).toLocaleString('vi-VN');
modalDeadline.textContent = (new Date(DEADLINE)).toLocaleString('vi-VN');
reviewTimeBtn.addEventListener("click", () => timeInfoModal.classList.remove("hidden"));
closeTimeInfo.addEventListener("click", () => timeInfoModal.classList.add("hidden"));

schoolSelect.addEventListener("change", () => {
  if (schoolSelect.value === "Khác") {
    schoolInput.classList.remove("hidden");
    schoolInput.value = "";
  } else {
    schoolInput.classList.add("hidden");
    schoolInput.value = schoolSelect.value;
  }
});
let warningCount = 0;
document.addEventListener("visibilitychange", function() {
    if (document.hidden) {
        warningCount++;
        alert("⚠️ Bạn đã rời khỏi màn hình làm bài.Số lần còn lại là:  " + (WARNING - warningCount));
        if (warningCount >= WARNING ) {
            alert("Bạn đã vi phạm quá số lần cho phép. Hệ thống sẽ nộp bài!");
            // Hàm autoSubmit() cần viết sẵn để nộp bài
            submitQuiz(true);
        }
    }
});

// Countdown
function formatDiff(ms) {
  if (ms < 0) ms = 0;
  const totalSeconds = Math.floor(ms/1000);
  const h = Math.floor(totalSeconds/3600);
  const m = Math.floor((totalSeconds%3600)/60);
  const s = totalSeconds%60;
  return h + "h " + m + "m " + s + "s";
}
// ===== Thông báo thời gian mở, tổng số lượt làm, số thời gian còn mở để
function updateCountdown() {
  const now = new Date();
  const startDate = new Date(START_TIME);
  const endDate = new Date(DEADLINE);
  let msg = "";
  if (now < startDate) {
    msg = "⏳ Bài kiểm tra sẽ mở sau: " + formatDiff(startDate - now);
    startBtn.disabled = true;
  } else if (now <= endDate) {
    msg = "📝 Bài kiểm tra đang mở. Bạn có tất cả " + ATTEMPT_LIMIT + " lượt thi. Còn thời gian tới khi đóng đề " + formatDiff(endDate - now);
    startBtn.disabled = false;
  } else {
    msg = "❌ Bài kiểm tra đã kết thúc.";
    startBtn.disabled = true;
    startBtn.textContent = "Đã hết hạn làm bài";
    startBtn.classList.add('bg-gray-400','cursor-not-allowed');
  }
  countdownEl.textContent = msg;
}
setInterval(updateCountdown, 1000);
updateCountdown();

// Utils
function shuffleArray(array){ for(let i=array.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [array[i],array[j]]=[array[j],array[i]]; } }
function prepareShuffledQuiz(){ const grouped = originalQuizData.reduce((acc,q)=>{ acc[q.part]=acc[q.part]||[]; acc[q.part].push(q); return acc; },{}); let res=[]; for(const p in grouped){ shuffleArray(grouped[p]); res=res.concat(grouped[p]); } return res; }

let quizData=[];
const totalQuestions = originalQuizData.length;
document.getElementById("total-questions-display").textContent = totalQuestions;

let currentUser = null;
let quizStartTime = null;
let timerInterval = null;
let timeLeftSeconds = TIME_LIMIT_SECONDS;
let currentQuestionIndex = 0;
let userAnswers = new Array(totalQuestions).fill(null);

// Start: kiểm tra thời gian & số lượt thi
startBtn.addEventListener("click", async ()=>{
  const now = new Date();
  const startDate = new Date(START_TIME);
  const endDate = new Date(DEADLINE);
  if (now < startDate) { alert("Bài kiểm tra chưa mở."); return; }
  if (now > endDate) { alert("Bài kiểm tra đã đóng."); return; }

  const studentId = studentIdInput.value.trim();
  const fullname = fullnameInput.value.trim();
  const className = classNameInput.value.trim();
  let school = schoolSelect.value === "Khác" ? schoolInput.value.trim() : schoolSelect.value;

  if (!studentId || !fullname || !className || !school) { alert("Vui lòng nhập đầy đủ thông tin!"); return; }

  // Kiểm tra số lượt thi (Firestore)
  try {
    const resultsRef = collection(db, "quizResults");
    const q = query(resultsRef, where("studentId","==", studentId), where("examCode","==", EXAM_CODE), where("quizId","==", QUIZ_ID));
    const snap = await getDocs(q);
    if (snap.size >= ATTEMPT_LIMIT) {
      alert("Bạn đã hết lượt làm bài cho kỳ thi này.");
      return;
    }
  } catch(err){
    console.error("Lỗi kiểm tra lượt thi:", err);
    alert("Lỗi khi kiểm tra lượt thi. Vui lòng thử lại.");
    return;
  }

  currentUser = { examCode: EXAM_CODE, studentId, fullname, className, school };
  announcementModal.classList.remove("hidden");
});

document.getElementById("enterQuizBtn").addEventListener("click", ()=>{
  announcementModal.classList.add("hidden");
  userInfoSection.classList.add("hidden");
  quizSection.classList.remove("hidden");
  startQuiz();
});
document.getElementById("exitBtn").addEventListener("click", ()=> announcementModal.classList.add("hidden"));

function startQuiz(){
  quizData = prepareShuffledQuiz();
  userAnswers = new Array(totalQuestions).fill(null);
  currentQuestionIndex = 0;
  quizStartTime = Date.now();
  timeLeftSeconds = TIME_LIMIT_SECONDS;
  document.getElementById("total-questions-display").textContent = totalQuestions;
  renderNavPanel();
  jumpToQuestion(0);
  startTimer();
}

// Timer
function startTimer(){
  if (timerInterval) clearInterval(timerInterval);
  updateTimerDisplay(timeLeftSeconds);
  timerInterval = setInterval(()=>{
    timeLeftSeconds--;
    if (timeLeftSeconds <= 0) { clearInterval(timerInterval); alert("⏰ Hết giờ! Bài thi sẽ được nộp tự động."); submitQuiz(true); }
    else updateTimerDisplay(timeLeftSeconds);
  }, 1000);
}
function updateTimerDisplay(sec){
  const m = Math.floor(sec/60).toString().padStart(2,'0');
  const s = (sec%60).toString().padStart(2,'0');
  timerElement.textContent = m + ":" + s;
}

// Render nav
function renderNavPanel(){
  questionNavPanel.innerHTML = '';
  for (let i=0;i<totalQuestions;i++){
    const btn = document.createElement('button');
    btn.textContent = i+1;
    btn.className = 'nav-btn w-10 h-10 border rounded font-medium';
    btn.type = 'button';
    btn.onclick = ()=>{ saveCurrentAnswer(); jumpToQuestion(i); };
    questionNavPanel.appendChild(btn);
  }
}
function jumpToQuestion(idx){
  currentQuestionIndex = idx;
  showQuestion();
  updateNavPanel();
}
function showQuestion(){
  const q = quizData[currentQuestionIndex];
  document.getElementById("quiz-part-title").textContent = q.part || "";
  document.getElementById("question-counter").textContent = currentQuestionIndex + 1;
  document.getElementById("question-text").innerHTML = q.question || "";
  answerContainer.innerHTML = "";
  switch(q.type){
    case 'mcq': renderMCQ(q); break;
    case 'true-false': renderTrueFalse(q); break;
    case 'short-answer': renderShortAnswer(q); break;
    default: renderMCQ(q);
  }
  if (window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise();
  prevBtn.classList.toggle('hidden', currentQuestionIndex === 0);
  nextBtn.classList.toggle('hidden', currentQuestionIndex === totalQuestions - 1);
}
function updateNavPanel(){
  const navs = questionNavPanel.children;
  for (let i=0;i<navs.length;i++){
    navs[i].classList.remove('nav-btn-current','nav-btn-answered');
    if (userAnswers[i] !== null) navs[i].classList.add('nav-btn-answered');
    if (i === currentQuestionIndex) navs[i].classList.add('nav-btn-current');
  }
}

// Lưu câu trả lời
function saveCurrentAnswer(){
  const q = quizData[currentQuestionIndex];
  if (!q) return;
  let ans = null;
  if (q.type === 'mcq'){
    const r = quizForm.querySelector('input[name="q'+currentQuestionIndex+'"]:checked');
    if (r) ans = r.value;
  } else if (q.type === 'true-false'){
    ans = [];
    for (let i=0;i<q.s.length;i++){
      const r = quizForm.querySelector('input[name="q'+currentQuestionIndex+'s'+i+'"]:checked');
      ans.push(r ? (r.value === 'true') : null);
    }
    if (ans.every(x => x === null)) ans = null;
  } else if (q.type === 'short-answer'){
    const inp = quizForm.querySelector('input[name="q'+currentQuestionIndex+'"]');
    if (inp && inp.value.trim() !== '') ans = inp.value.trim();
  }
  userAnswers[currentQuestionIndex] = ans;
  updateNavPanel();
}

// Render MCQ/TF/Short
function renderMCQ(question){
  const saved = userAnswers[currentQuestionIndex];
  const options = [...question.o];
  options.forEach(opt => {
    const div = document.createElement('div');
    const label = document.createElement('label');
    label.className = "flex items-center p-3 rounded-lg border cursor-pointer hover:bg-gray-50";
    const radio = document.createElement('input');
    radio.type = 'radio'; radio.name = 'q'+currentQuestionIndex; radio.value = opt; radio.className = 'mr-3';
    if (saved === opt) { radio.checked = true; label.classList.add('mcq-label-selected'); }
    radio.addEventListener('change', ()=> { answerContainer.querySelectorAll('label').forEach(l=>l.classList.remove('mcq-label-selected')); label.classList.add('mcq-label-selected'); saveCurrentAnswer(); });
    const span = document.createElement('span'); span.innerHTML = opt;
    label.appendChild(radio); label.appendChild(span); div.appendChild(label); answerContainer.appendChild(div);
  });
}
function renderTrueFalse(question){
  const saved = userAnswers[currentQuestionIndex] || [];
  question.s.forEach((st, idx) => {
    const div = document.createElement('div'); div.className = 'flex items-center justify-between p-3 border rounded-lg';
    const span = document.createElement('span'); span.innerHTML = st.text;
    const group = document.createElement('div'); group.className = 'flex gap-4';
    const trueLabel = document.createElement('label'); trueLabel.className='cursor-pointer flex items-center';
    const tRadio = document.createElement('input'); tRadio.type='radio'; tRadio.name='q'+currentQuestionIndex+'s'+idx; tRadio.value='true'; tRadio.className='mr-2';
    if (saved[idx] === true) tRadio.checked = true; tRadio.addEventListener('change', saveCurrentAnswer);
    trueLabel.appendChild(tRadio); trueLabel.append(' Đúng');
    const falseLabel = document.createElement('label'); falseLabel.className='cursor-pointer flex items-center';
    const fRadio = document.createElement('input'); fRadio.type='radio'; fRadio.name='q'+currentQuestionIndex+'s'+idx; fRadio.value='false'; fRadio.className='mr-2';
    if (saved[idx] === false) fRadio.checked = true; fRadio.addEventListener('change', saveCurrentAnswer);
    falseLabel.appendChild(fRadio); falseLabel.append(' Sai');
    group.appendChild(trueLabel); group.appendChild(falseLabel);
    div.appendChild(span); div.appendChild(group); answerContainer.appendChild(div);
  });
}
function renderShortAnswer(question){
  const saved = userAnswers[currentQuestionIndex] || '';
  const input = document.createElement('input'); input.type='text'; input.name='q'+currentQuestionIndex;
  input.className = 'w-full border rounded px-3 py-2 mt-2'; input.placeholder = 'Nhập đáp án'; input.value = saved;
  input.addEventListener('input', saveCurrentAnswer); answerContainer.appendChild(input);
}

// Prev/Next
prevBtn.addEventListener('click', ()=>{ saveCurrentAnswer(); if (currentQuestionIndex>0) jumpToQuestion(currentQuestionIndex-1); });
nextBtn.addEventListener('click', ()=>{ saveCurrentAnswer(); if (currentQuestionIndex<totalQuestions-1) jumpToQuestion(currentQuestionIndex+1); });

// Submit (modal confirm)
let isAutoSubmit = false;
quizForm.addEventListener('submit', (e)=> {
  e.preventDefault();
  if (isAutoSubmit) { isAutoSubmit = false; submitQuiz(true); return; }
  confirmSubmitModal.classList.remove('hidden');
});
confirmYes.addEventListener('click', ()=>{ confirmSubmitModal.classList.add('hidden'); submitQuiz(false); });
confirmNo.addEventListener('click', ()=>{ confirmSubmitModal.classList.add('hidden'); });

// Thực hiện submit
async function submitQuiz(auto=false){
  saveCurrentAnswer();
  if (timerInterval) clearInterval(timerInterval);
  const timeTakenSeconds = Math.round((Date.now() - quizStartTime)/1000);
  let totalScore = 0;
  const answersToSave = {};
  quizData.forEach((q, idx) => {
    const ua = userAnswers[idx];
    answersToSave['q'+(idx+1)] = ua;
    if (ua === null) return;
    if (q.type === 'mcq') {
      if (ua === q.a) totalScore += SCORE_MCQ;
    } else if (q.type === 'true-false') {
      let correctCount = 0;
      q.s.forEach((st, sIdx) => { if (ua && ua[sIdx] === st.a) correctCount++; });
      totalScore += (POINTS_MAP_TF[correctCount] || 0);
    } else if (q.type === 'short-answer') {
      if (typeof ua === 'string' && ua.trim().toLowerCase() === String(q.a).trim().toLowerCase()) totalScore += SCORE_SHORT;
    }
  });
   
if (document.getElementById("quizSection")) {
  document.getElementById("quizSection").style.opacity = 0;
  setTimeout(()=>document.getElementById("quizSection").style.opacity=1,2000);
}


  quizSection.classList.add('hidden');
  resultSection.classList.remove('hidden');
  document.getElementById("studentNameResult").textContent = (currentUser && currentUser.fullname) ? currentUser.fullname : "";

  document.getElementById("finalScore").textContent = totalScore.toFixed(2);

  // Lưu lên Firestore
  try {
    await addDoc(collection(db, "quizResults"), {
      ...currentUser,
      quizId: QUIZ_ID,
      examCode: EXAM_CODE,
      score: parseFloat(totalScore.toFixed(2)),
      totalPossibleScore: totalQuestions * SCORE_MCQ,
      timeTaken: timeTakenSeconds,
      answers: answersToSave,
      warningCount: warningCount,
      submittedAt: serverTimestamp()
    });
  } catch (err) {
    console.error("Lỗi khi lưu kết quả:", err);
    alert("Đã có lỗi khi lưu kết quả. Vui lòng thử lại hoặc liên hệ quản trị.");
  }
}

// Auto submit (khi hết giờ)
function autoSubmitNow(){ isAutoSubmit = true; quizForm.requestSubmit(); }

// Lấy thông tin học sinh từ Google Sheet Web App
studentIdInput.addEventListener('blur', async () => {
  const id = studentIdInput.value.trim();
  if (!id) return;
  try {
    const res = await fetch(API_URL + '?id=' + encodeURIComponent(id));
    const data = await res.json();
    if (data && data.studentId) {
      fullnameInput.value = data.fullname || '';
      classNameInput.value = data.className || '';
      const schoolVal = data.school || '';
      if (schoolSelect.querySelector('option[value="' + schoolVal + '"]')) {
        schoolSelect.value = schoolVal;
        schoolInput.classList.add('hidden');
      } else {
        schoolSelect.value = 'Khác';
        schoolInput.classList.remove('hidden');
        schoolInput.value = schoolVal;
      }
    } else {
      alert('❌ Không tìm thấy số báo danh này trong danh sách.');
      fullnameInput.value = '';
      classNameInput.value = '';
      schoolSelect.value = '';
      schoolInput.value = '';
    }
  } catch (err) {
    console.error('Lỗi lấy dữ liệu:', err);
    alert('Lỗi kết nối tới Google Sheet. Vui lòng thử lại.');
  }
});

// Cleanup
window.addEventListener('beforeunload', ()=> { if (timerInterval) clearInterval(timerInterval); });


</script>
</body>
</html>
