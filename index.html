<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toán Thầy Hà</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .nav-btn { transition: background-color 0.2s, color 0.2s, border-color 0.2s; }
        .nav-btn-answered { background-color: #16a34a; color: white; border-color: #15803d; }
        .nav-btn-current { background-color: #4f46e5; color: white; border-color: #4338ca; transform: scale(1.1); }
        input[type="radio"]:checked + span { font-weight: 600; color: #4f46e5; }
        .mcq-label-selected { background-color: #e0e7ff; border-color: #6366f1; }
        @keyframes blinkingColors {
            0%, 100% { color: #22c55e; }
            33% { color: #ef4444; }
            66% { color: #eab308; }
        }
        .blinking-text { animation: blinkingColors 3s infinite; }
        #startBtn:disabled { background-color: #9ca3af; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div id="main-container" class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-6">
        <h1 class="text-2xl font-bold text-center mb-6 blinking-text">Lớp Toán Thầy Hà</h1>
        
        <div id="userInfoSection" class="max-w-md mx-auto">
            <h2 class="text-xl font-semibold text-center mb-4">Thông tin thí sinh</h2>
            <div class="mb-4">
                <label class="block font-bold text-center text-blue-600">Mã kỳ thi (Kiểm tra)</label>
                <p id="examCodeDisplay" class="w-full text-center text-lg font-bold text-red-600 p-2 mt-1"></p>
            </div>
            <div class="mb-3">
                <label class="block font-medium">Số báo danh (VD: 540112)</label>
                <input type="text" id="studentId" class="w-full border rounded px-3 py-2 mt-1" placeholder="Nhập SBD để tự động điền..." required>
            </div>
            <div class="mb-3">
                <label class="block font-medium">Họ và tên</label>
                <input type="text" id="fullname" class="w-full border rounded px-3 py-2 mt-1 bg-gray-100" readonly>
            </div>
            <div class="mb-3">
                <label class="block font-medium">Lớp</label>
                <input type="text" id="className" class="w-full border rounded px-3 py-2 mt-1 bg-gray-100" readonly>
            </div>
            <div class="mb-3">
                <label class="block font-medium">Trường</label>
                <input type="text" id="school" class="w-full border rounded px-3 py-2 mt-1 bg-gray-100" readonly>
            </div>
            <div class="mb-4">
                <label class="block font-medium">Mật khẩu</label>
                <input type="password" id="password" class="w-full border rounded px-3 py-2 mt-1" required>
            </div>
            <button id="startBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded mt-2">Bắt đầu làm bài</button>
            <p id="error-message" class="text-red-500 text-center mt-2 h-4"></p>
        </div>

        <div id="quizSection" class="hidden">
            <div id="quiz-header" class="flex justify-between items-start border-b pb-4 mb-4">
                <div>
                    <h2 id="quiz-part-title" class="text-xl md:text-2xl font-bold text-gray-800"></h2>
                    <p class="text-lg font-semibold text-blue-600">Câu <span id="question-counter">1</span> / <span id="total-questions-display"></span></p>
                </div>
                <div id="timer" class="text-2xl font-bold text-red-500">60:00</div>
            </div>
            <div id="questionNavPanel" class="flex flex-wrap gap-2 p-3 border-b mb-4 bg-gray-50 rounded-lg"></div>
            <form id="quizForm" class="space-y-6">
                <p id="question-text" class="text-lg font-medium text-gray-800 min-h-[48px]"></p>
                <div id="answer-container" class="space-y-3"></div>
                <div class="flex justify-between items-center pt-4 mt-4 border-t">
                    <button type="button" id="prevBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded">Câu trước</button>
                    <button type="submit" id="submitBtn" class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded text-lg font-bold">Nộp bài</button>
                    <button type="button" id="nextBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded">Câu sau</button>
                </div>
            </form>
        </div>
        
        <div id="resultSection" class="hidden text-center">
            <h2 id="studentNameResult" class="text-2xl font-bold mb-2"></h2>
            <p class="text-lg mb-4">Đã hoàn thành bài kiểm tra!</p>
            <p class="text-xl">Tổng điểm của bạn là: <span id="finalScore" class="font-bold text-blue-600 text-3xl"></span></p>
            <p class="mt-4 text-gray-600">Kết quả đã được lưu vào hệ thống.</p>
            <div class="mt-8 p-4 border-t bg-gray-50 rounded-lg">
                <img src="https://placehold.co/300x300/3B82F6/FBBF24?text=TOÁN%0ATHẦY+HÀ&font=times-new-roman&css=%7B%22font-weight%22%3A%22bold%22%2C%22font-size%22%3A%2290px%22%7D" alt="Logo Toán Thầy Hà" class="mx-auto mb-4 rounded-full shadow-lg border-4 border-yellow-400 h-32 w-32 object-cover">
                <h3 class="text-lg font-bold mb-2">Lớp toán thầy Hà tiếp tục tuyển sinh</h3>
                <p class="text-gray-600">Nhóm dạy ít học sinh(10-15) đảm bảo sát sao và chất lượng!<br>Cam kết tiến bộ và cam kết đầu ra!<br>Địa chỉ học: Xuân Phú – Tân Tiến – Bắc Ninh!<br>Liên hệ qua Zalo: <strong>0988.948.882</strong></p>
            </div>
        </div>
    </div>
    
    <div id="announcementModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-lg p-8 max-w-lg w-full text-center">
            <img src="https://placehold.co/300x300/3B82F6/FBBF24?text=TOÁN%0ATHẦY+HÀ&font=times-new-roman&css=%7B%22font-weight%22%3A%22bold%22%2C%22font-size%22%3A%2290px%22%7D" alt="Logo Toán Thầy Hà" class="mx-auto mb-4 rounded-full shadow-lg border-4 border-yellow-400 h-32 w-32 object-cover">
            <h2 class="text-xl font-bold mb-2">Lớp toán thầy Hà tiếp tục tuyển sinh</h2>
            <p class="text-gray-600 mb-6">Nhóm dạy ít học sinh(10-15) đảm bảo sát sao và chất lượng!<br>Cam kết tiến bộ và cam kết đầu ra!<br>Địa chỉ học: Xuân Phú – Tân Tiến – Bắc Ninh!<br>Liên hệ qua Zalo: <strong>0988.948.882</strong></p>
            <div class="flex justify-center gap-4">
                <button id="enterQuizBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-8 py-2 rounded">Vào thi</button>
                <button id="exitBtn" class="bg-red-500 hover:bg-red-600 text-white px-8 py-2 rounded">Thoát</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAwM9_H8PTooz3Nh4MPt9wdtBScIvMC318",
            authDomain: "toanthayha-cd96c.firebaseapp.com",
            projectId: "toanthayha-cd96c",
            storageBucket: "toanthayha-cd96c.firebasestorage.app",
            messagingSenderId: "940207284081",
            appId: "1:940207284081:web:9801158f72cc14053ae0d0",
            measurementId: "G-9D5ZQ66BSB"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const EXAM_CODE = "Toan09_001";
        const QUIZ_ID = "toanthayha_09";
        const TIME_LIMIT_SECONDS = 60 * 60;
        const ATTEMPT_LIMIT = 500;
        const QUIZ_PASSWORD = "toanthayha"; 
        
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTtSIetmTmcYtZ7B7SCJSzCFgoHckuFxKYFVcjqMNiG1_m1X8UKkkfa5N49TTtnnXjE747ep5eKb9B0/pub?output=csv';
        let studentList = [];

        const originalQuizData = [
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Trong các câu sau, câu nào là mệnh đề?', o: ["Số 3 là số chẵn.", "Bạn tên gì?", "Hôm nay trời đẹp quá!", "Hãy học bài đi!"], a: "Số 3 là số chẵn." },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Phủ định của mệnh đề P: “∀x ∈ ℝ, x² ≥ 0” là:', o: ["∃x ∈ ℝ, x² < 0", "∃x ∈ ℝ, x² ≤ 0", "∀x ∈ ℝ, x² < 0", "∀x ∈ ℝ, x² ≤ 0"], a: "∃x ∈ ℝ, x² < 0" },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Cho tập hợp A = {1, 2, {3, 4}}. Khẳng định nào sau đây sai?', o: ["1 ∈ A", "2 ∈ A", "{3, 4} ∈ A", "3 ∈ A"], a: "3 ∈ A" },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Ký hiệu nào biểu diễn khoảng từ a đến b, không bao gồm a và b?', o: ["[a; b]", "(a; b)", "[a; b)", "(a; b]"], a: "(a; b)" },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Cho A = {1, 3, 5} và B = {1, 2, 3}. Tập hợp A ∪ B là:', o: ["{1, 3}", "{1, 2, 3, 5}", "{1, 2, 5}", "{2, 5}"], a: "{1, 2, 3, 5}" },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Cho A = {x ∈ ℕ | x ≤ 4}. Liệt kê các phần tử của A.', o: ["{1, 2, 3, 4}", "{0, 1, 2, 3}", "{0, 1, 2, 3, 4}", "{1, 2, 3}"], a: "{0, 1, 2, 3, 4}" },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Mệnh đề P ⇒ Q chỉ sai khi nào?', o: ["P đúng, Q sai", "P sai, Q đúng", "P, Q cùng đúng", "P, Q cùng sai"], a: "P đúng, Q sai" },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Cho A = (–∞; 2] và B = (–1; +∞). Tập hợp A ∩ B là:', o: ["(–1; 2]", "[–1; 2]", "(–∞; +∞)", "(–1; 2)"], a: "(–1; 2]" },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Số tập hợp con có 2 phần tử của tập hợp A = {a, b, c, d} là:', o: ["4", "6", "8", "10"], a: "6" },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Cho mệnh đề P(x): “x là số nguyên tố”. Mệnh đề nào sau đây đúng?', o: ["P(4)", "P(6)", "P(8)", "P(7)"], a: "P(7)" },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Tập hợp A = {x ∈ ℝ | x² - 4 = 0} có bao nhiêu phần tử?', o: ["0", "1", "2", "4"], a: "2" },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Cho A là tập con của B. Khẳng định nào sau đây đúng?', o: ["A ∩ B = B", "A ∪ B = A", "B \\ A = ∅", "A ∩ B = A"], a: "A ∩ B = A" },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Mệnh đề “Nếu tam giác ABC đều thì nó có ba góc bằng 60°” có mệnh đề đảo là:', o: ["Nếu tam giác ABC có ba góc bằng 60° thì nó đều.", "Nếu tam giác ABC không đều thì nó không có ba góc bằng 60°.", "Tam giác ABC đều khi và chỉ khi nó có ba góc bằng 60°.", "Tam giác ABC đều và có ba góc bằng 60°."], a: "Nếu tam giác ABC có ba góc bằng 60° thì nó đều." },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Sử dụng ký hiệu ∀, ∃ để viết mệnh đề: “Mọi số thực cộng với 0 đều bằng chính nó”', o: ["∀x ∈ ℝ, x + 0 = x", "∃x ∈ ℝ, x + 0 = x", "∀x ∈ ℝ, x + 0 = 0", "∃x ∈ ℝ, x + 0 = 0"], a: "∀x ∈ ℝ, x + 0 = x" },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Tập hợp rỗng được ký hiệu là:', o: ["{0}", "0", "∅", "{∅}"], a: "∅" },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Cho A = [–3; 5) và B = (2; 7]. Tập hợp A \\ B là:', o: ["[–3; 2]", "[–3; 2)", "(–3; 2]", "(5; 7]"], a: "[–3; 2]" },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Câu nào sau đây không phải là mệnh đề chứa biến?', o: ["x + 2 > 5", "n là số chẵn", "Hà Nội là thủ đô của Việt Nam", "2k + 1 là số lẻ"], a: "Hà Nội là thủ đô của Việt Nam" },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Cho A = {x ∈ ℤ | |x| < 3}. Số phần tử của A là:', o: ["2", "3", "4", "5"], a: "5" },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Phần bù của tập A = [2; +∞) trong ℝ là:', o: ["(–∞; 2]", "(–∞; 2)", "[2; +∞)", "(2; +∞)"], a: "(–∞; 2)" },
            { part: "Phần I: Trắc nghiệm nhiều lựa chọn", type: 'mcq', question: 'Mệnh đề nào sau đây là mệnh đề tương đương?', o: ["P ⇒ Q", "P ⇔ Q", "P ∧ Q", "P ∨ Q"], a: "P ⇔ Q" },
            { part: "Phần II: Trắc nghiệm Đúng/Sai", type: 'true-false', question: 'Cho tập hợp A = {1, 2} và B = {1, 2, 3}. Xét tính đúng sai của các mệnh đề sau:', s: [ { text: "A là tập con của B.", a: true }, { text: "B là tập con của A.", a: false }, { text: "A ∩ B = {1, 2, 3}.", a: false }, { text: "A ∪ B = B.", a: true } ] },
            { part: "Phần II: Trắc nghiệm Đúng/Sai", type: 'true-false', question: 'Cho mệnh đề P: “x > 5” và Q: “x > 3”. Xét tính đúng sai của các mệnh đề sau:', s: [ { text: "Với x = 6, mệnh đề P đúng.", a: true }, { text: "Mệnh đề P ⇒ Q là mệnh đề đúng.", a: true }, { text: "Mệnh đề Q ⇒ P là mệnh đề đúng.", a: false }, { text: "Mệnh đề P ⇔ Q là mệnh đề đúng.", a: false } ] },
            { part: "Phần III: Trả lời ngắn", type: 'short-answer', question: 'Cho hai tập hợp A = {1, 2, 3, 4, 5} và B = {2, 4, 6, 8}. Tập hợp A ∩ B có bao nhiêu phần tử?', a: "2" },
            { part: "Phần III: Trả lời ngắn", type: 'short-answer', question: 'Lớp 10A có 30 học sinh giỏi Toán, 25 học sinh giỏi Lý, và 15 học sinh giỏi cả Toán và Lý. Hỏi lớp 10A có bao nhiêu học sinh giỏi ít nhất một trong hai môn Toán hoặc Lý?', a: "40" },
            { part: "Phần III: Trả lời ngắn", type: 'short-answer', question: 'Cho tập hợp M = {x ∈ ℤ | (x² - 9)(x - 1) = 0}. Tính tổng các phần tử của M.', a: "1" }
        ];

        let quizData = [], userAnswers = [];
        let currentUser = null, timerInterval = null, currentQuestionIndex = 0, quizStartTime = null;
        const totalQuestions = originalQuizData.length;

        const mainContainer = document.getElementById('main-container');
        const startBtn = document.getElementById("startBtn");
        const studentIdInput = document.getElementById('studentId');
        const fullnameInput = document.getElementById('fullname');
        const classNameInput = document.getElementById('className');
        const schoolInput = document.getElementById('school');
        const passwordInput = document.getElementById('password');
        const errorMessage = document.getElementById('error-message');
        const userInfoSection = document.getElementById("userInfoSection");
        const quizSection = document.getElementById("quizSection");
        const resultSection = document.getElementById("resultSection");
        const announcementModal = document.getElementById('announcementModal');
        const enterQuizBtn = document.getElementById('enterQuizBtn');
        const exitBtn = document.getElementById('exitBtn');
        const quizForm = document.getElementById("quizForm");
        const studentNameResult = document.getElementById("studentNameResult");
        const finalScore = document.getElementById("finalScore");
        const timerElement = document.getElementById("timer");
        const quizPartTitle = document.getElementById('quiz-part-title');
        const questionCounter = document.getElementById('question-counter');
        const totalQuestionsDisplay = document.getElementById('total-questions-display');
        const questionNavPanel = document.getElementById('questionNavPanel');
        const questionText = document.getElementById('question-text');
        const answerContainer = document.getElementById('answer-container');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        document.getElementById("examCodeDisplay").textContent = EXAM_CODE;
        
        async function loadStudentList() {
            startBtn.disabled = true;
            startBtn.textContent = "Đang tải danh sách lớp...";
            try {
                const response = await fetch(GOOGLE_SHEET_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                const csvText = await response.text();
                const lines = csvText.trim().split(/\r?\n/);
                let headers = lines[0].split(',').map(h => h.trim());
                headers[0] = headers[0].replace(/^\uFEFF/, ''); 
                studentList = lines.slice(1).map(line => {
                    const values = line.split(',');
                    const studentObject = {};
                    headers.forEach((header, index) => {
                        studentObject[header] = (values[index] || '').trim();
                    });
                    return studentObject;
                });
                console.log("Tải danh sách học sinh thành công!");
                startBtn.disabled = false;
                startBtn.textContent = "Bắt đầu làm bài";
            } catch (error) {
                console.error("Lỗi khi tải danh sách học sinh:", error);
                errorMessage.textContent = "Lỗi tải danh sách lớp. F5 để thử lại.";
            }
        }
        
        loadStudentList();

        studentIdInput.addEventListener('input', () => {
            const enteredId = studentIdInput.value.trim();
            const foundStudent = studentList.find(s => s.id === enteredId);
            fullnameInput.value = foundStudent ? foundStudent.name : '';
            classNameInput.value = foundStudent ? foundStudent.className : '';
            schoolInput.value = foundStudent ? foundStudent.school : '';
            errorMessage.textContent = '';
        });

        startBtn.addEventListener("click", async () => {
            const studentId = studentIdInput.value.trim();
            const fullname = fullnameInput.value.trim();
            const password = passwordInput.value.trim();
            errorMessage.textContent = '';

            if (!studentId || !fullname) {
                errorMessage.textContent = "Số báo danh không hợp lệ!";
                return;
            }
            if (password !== QUIZ_PASSWORD) {
                errorMessage.textContent = "Mật khẩu không chính xác!";
                return;
            }

            currentUser = { 
                examCode: EXAM_CODE, 
                studentId: studentId, 
                fullname: fullname, 
                className: classNameInput.value, 
                school: schoolInput.value 
            };
            
            const resultsRef = collection(db, "quizResults");
            const q = query(resultsRef, where("studentId", "==", currentUser.studentId), where("quizId", "==", QUIZ_ID), where("examCode", "==", EXAM_CODE));
            const snapshot = await getDocs(q);
            if (snapshot.size >= ATTEMPT_LIMIT) {
                errorMessage.textContent = `Bạn đã làm bài này ${snapshot.size} lần.`;
                return;
            }
            
            mainContainer.classList.add('hidden');
            announcementModal.classList.remove('hidden');
        });

        enterQuizBtn.addEventListener('click', () => {
            announcementModal.classList.add('hidden');
            mainContainer.classList.remove('hidden');
            userInfoSection.classList.add("hidden");
            quizSection.classList.remove("hidden");
            startQuiz();
        });

        exitBtn.addEventListener('click', () => { location.reload(); });

        function prepareShuffledQuiz() {
            const groupedByPart = originalQuizData.reduce((acc, question) => {
                acc[question.part] = acc[question.part] || [];
                acc[question.part].push(question);
                return acc;
            }, {});
            let shuffledQuiz = [];
            for (const part in groupedByPart) {
                const questionsInPart = [...groupedByPart[part]];
                for (let i = questionsInPart.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [questionsInPart[i], questionsInPart[j]] = [questionsInPart[j], questionsInPart[i]];
                }
                shuffledQuiz.push(...questionsInPart);
            }
            return shuffledQuiz;
        }

        function startQuiz() {
            quizData = prepareShuffledQuiz();
            userAnswers = new Array(totalQuestions).fill(null);
            currentQuestionIndex = 0;
            quizStartTime = Date.now();
            totalQuestionsDisplay.textContent = totalQuestions;
            renderNavPanel();
            jumpToQuestion(0);
            startTimer();
        }        
        let timeLeft = TIME_LIMIT_SECONDS;
            timerInterval = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitBtn.click();
                } else {
                    timeLeft--;
                    const minutes = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                    const seconds = (timeLeft % 60).toString().padStart(2, '0');
                    timerElement.textContent = `${minutes}:${seconds}`;
                }
            }, 1000);
        }

        function renderNavPanel() {
            questionNavPanel.innerHTML = '';
            for (let i = 0; i < totalQuestions; i++) {
                const btn = document.createElement('button');
                btn.textContent = i + 1;
                btn.className = 'nav-btn w-10 h-10 border rounded font-medium';
                btn.type = 'button';
                btn.onclick = () => { saveCurrentAnswer(); jumpToQuestion(i); };
                questionNavPanel.appendChild(btn);
            }
        }

        function jumpToQuestion(index) {
            currentQuestionIndex = index;
            showQuestion();
            updateNavPanel();
        }

        function showQuestion() {
            const question = quizData[currentQuestionIndex];
            quizPartTitle.textContent = question.part;
            questionCounter.textContent = currentQuestionIndex + 1;
            questionText.innerHTML = question.question;
            answerContainer.innerHTML = '';

            switch (question.type) {
                case 'mcq': renderMCQ(question); break;
                case 'true-false': renderTrueFalse(question); break;
                case 'short-answer': renderShortAnswer(question); break;
            }
            
            prevBtn.classList.toggle('hidden', currentQuestionIndex === 0);
            nextBtn.classList.toggle('hidden', currentQuestionIndex === totalQuestions - 1);
        }
        
        function updateNavPanel() {
            const navButtons = questionNavPanel.children;
            for (let i = 0; i < navButtons.length; i++) {
                navButtons[i].classList.remove('nav-btn-current', 'nav-btn-answered');
                if (userAnswers[i] !== null) navButtons[i].classList.add('nav-btn-answered');
                if (i === currentQuestionIndex) navButtons[i].classList.add('nav-btn-current');
            }
        }

        function saveCurrentAnswer() {
            const question = quizData[currentQuestionIndex];
            let answerData = null;
            switch (question.type) {
                case 'mcq':
                    const selectedRadio = quizForm.querySelector(`input[name="q${currentQuestionIndex}"]:checked`);
                    if (selectedRadio) answerData = selectedRadio.value;
                    break;
                case 'true-false':
                    answerData = [];
                    for (let i = 0; i < question.s.length; i++) {
                        const selectedTF = quizForm.querySelector(`input[name="q${currentQuestionIndex}s${i}"]:checked`);
                        answerData.push(selectedTF ? selectedTF.value === 'true' : null);
                    }
                    if (answerData.every(a => a === null)) answerData = null;
                    break;
                case 'short-answer':
                    const input = quizForm.querySelector(`input[name="q${currentQuestionIndex}"]`);
                    if (input && input.value.trim() !== '') answerData = input.value.trim();
                    break;
            }
            userAnswers[currentQuestionIndex] = answerData;
            updateNavPanel();
        }
        prevBtn.addEventListener('click', () => { saveCurrentAnswer(); if (currentQuestionIndex > 0) jumpToQuestion(currentQuestionIndex - 1); });
        nextBtn.addEventListener('click', () => { saveCurrentAnswer(); if (currentQuestionIndex < totalQuestions - 1) jumpToQuestion(currentQuestionIndex + 1); });
        
        quizForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            saveCurrentAnswer(); 
            clearInterval(timerInterval);
            
            const timeTakenInSeconds = Math.round((Date.now() - quizStartTime) / 1000);
            let totalScore = 0;
            const answersToSave = {};

            quizData.forEach((q, index) => {
                const userAnswer = userAnswers[index];
                answersToSave[`q${index + 1}`] = userAnswer;
                if (userAnswer === null) return;

                switch (q.type) {
                    case 'mcq':
                        if (userAnswer === q.a) totalScore += 0.25;
                        break;
                    case 'true-false':
                        let correctCount = 0;
                        q.s.forEach((st, sIndex) => { if (userAnswer[sIndex] === st.a) correctCount++; });
                        const pointsMap = [0, 0.1, 0.25, 0.5, 1];
                        totalScore += pointsMap[correctCount] || 0;
                        break;
                    case 'short-answer':
                        if (userAnswer.toLowerCase() === q.a.toLowerCase()) totalScore += 1;
                        break;
                }
            });

        function renderMCQ(question) {
            const savedAnswer = userAnswers[currentQuestionIndex];
            const options = [...question.o];
            shuffleArray(options); // Xáo trộn đáp án
            options.forEach(option => {
                const isChecked = savedAnswer === option;
                answerContainer.innerHTML += `
                    <div><label class="flex items-center p-3 rounded-lg border cursor-pointer hover:bg-gray-50">
                        <input type="radio" name="q${currentQuestionIndex}" value="${option}" class="mr-3" ${isChecked ? 'checked' : ''}> 
                        <span>${option}</span>
                    </label></div>`;
            });
        }

        function renderTrueFalse(question) {
            const savedAnswer = userAnswers[currentQuestionIndex] || [];
            question.s.forEach((statement, sIndex) => {
                const isTrueChecked = savedAnswer[sIndex] === true;
                const isFalseChecked = savedAnswer[sIndex] === false;
                answerContainer.innerHTML += `
                    <div class="flex items-center justify-between p-3 border rounded-lg">
                        <span>${statement.text}</span>
                        <div class="flex gap-4">
                            <label class="cursor-pointer flex items-center">
                                <input type="radio" name="q${currentQuestionIndex}s${sIndex}" value="true" class="mr-2" ${isTrueChecked ? 'checked' : ''}> Đúng
                            </label>
                            <label class="cursor-pointer flex items-center">
                                <input type="radio" name="q${currentQuestionIndex}s${sIndex}" value="false" class="mr-2" ${isFalseChecked ? 'checked' : ''}> Sai
                            </label>
                        </div>
                    </div>`;
            });
        }
        
        function renderShortAnswer(question) {
            const savedAnswer = userAnswers[currentQuestionIndex] || '';
            answerContainer.innerHTML = `
                <input type="text" name="q${currentQuestionIndex}" class="w-full border rounded px-3 py-2 mt-2" 
                placeholder="Nhập đáp án(45 hoặc 20,5)" value="${savedAnswer}">`;
        }

    </script>
</body>
</html>
